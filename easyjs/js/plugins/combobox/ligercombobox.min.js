if(typeof LigerUIManagers=="undefined")LigerUIManagers={};(function($){$.fn.ligerGetComboBoxManager=function(){return LigerUIManagers[this[0].id+"_ComboBox"]};$.ligerDefaults=$.ligerDefaults||{};$.ligerDefaults.ComboBox={resize:false,isMultiSelect:false,isShowCheckBox:false,columns:false,selectBoxWidth:false,selectBoxHeight:false,onBeforeSelect:false,onSelected:null,initValue:null,initText:null,valueField:"pkId",textField:"treeName",valueFieldID:null,slide:true,split:";",data:null,tree:null,treeLeafOnly:true,grid:null,onStartResize:null,onEndResize:null,hideOnLoseFocus:true,url:null,onSuccess:null,onError:null,onBeforeOpen:null,render:null,showRoot:true,rootId:"0",rootText:"根节点"};$.fn.ligerComboBox=function(options){this.each(function(){if(this.usedComboBox)return;var p=$.extend({},options||{});if($(this).attr("ligerui")){try{var attroptions=$(this).attr("ligerui");if(attroptions.indexOf("{")<0)attroptions="{"+attroptions+"}";eval("attroptions = "+attroptions+";");if(attroptions)p=$.extend({},attroptions,p||{})}catch(e){}}p=$.extend({},$.ligerDefaults.ComboBox,p);if(p.columns){p.isShowCheckBox=true}if(p.isMultiSelect){p.isShowCheckBox=true}if(this.id==undefined)this.id="LigerUI_"+(new Date).getTime();var g={findTextByValue:function(e){if(e==undefined)return"";var t="";var l=function(t){var l=e.toString().split(p.split);for(var i=0;i<l.length;i++){if(l[i]==t)return true}return false};$(g.data).each(function(e,i){var a=i[p.valueField];var n=i[p.textField];if(l(a)){t+=n+p.split}});if(t.length>0)t=t.substr(0,t.length-1);return t},findValueByText:function(e){if(!e&&e=="")return"";var t=function(t){var l=e.toString().split(p.split);for(var i=0;i<l.length;i++){if(l[i]==t)return true}return false};var l="";$(g.data).each(function(e,i){var a=i[p.valueField];var n=i[p.textField];if(t(n)){l+=a+p.split}});if(l.length>0)l=l.substr(0,l.length-1);return l},removeItem:function(){},insertItem:function(){},addItem:function(){},changeValue:function(e,t){po.changeValue(e,t)},selectValue:function(e){var t=g.findTextByValue(e);if(p.tree){g.selectValueByTree(e)}else if(!p.isMultiSelect){po.changeValue(e,t);$("tr[value="+e+"] td",g.selectBox).addClass("l-selected");$("tr[value!="+e+"] td",g.selectBox).removeClass("l-selected")}else{po.changeValue(e,t);var l=e.toString().split(p.split);$("table.l-table-checkbox :checkbox",g.selectBox).each(function(){this.checked=false});for(var i=0;i<l.length;i++){$("table.l-table-checkbox tr[value="+l[i]+"] :checkbox",g.selectBox).each(function(){this.checked=true})}}},bulidContent:function(){this.clearContent();if(g.select){g.setSelect()}else if(g.data){g.setData(g.data)}else if(p.tree){g.setTree(p.tree)}else if(p.grid){g.setGrid(p.grid)}else if(p.url){$.ajax({type:"post",url:p.url,cache:false,dataType:"json",success:function(e){g.data=e;g.setData(g.data.Rows);if(p.onSuccess)p.onSuccess(g.data.Rows)},error:function(e,t){if(p.onError)p.onError(e,t)}})}},clearContent:function(){$("ul",g.selectBox).html("")},setSelect:function(){this.clearContent();$("option",g.select).each(function(e){var t=$(this).val();var l=$(this).html();var i=$("<tr><td index='"+e+"' value='"+t+"'>"+l+"</td>");$("table.l-table-nocheckbox",g.selectBox).append(i);$("td",i).hover(function(){$(this).addClass("l-over")},function(){$(this).removeClass("l-over")})});$("td:eq("+g.select[0].selectedIndex+")",g.selectBox).each(function(){if($(this).hasClass("l-selected")){g.selectBox.hide();return}$(".l-selected",g.selectBox).removeClass("l-selected");$(this).addClass("l-selected");if(g.select[0].selectedIndex!=$(this).attr("index")&&g.select[0].onchange){g.select[0].selectedIndex=$(this).attr("index");g.select[0].onchange()}var e=parseInt($(this).attr("index"));g.select[0].selectedIndex=e;g.select.trigger("change");g.selectBox.hide();g.inputText.val($(this).html())});po.addClickEven()},setData:function(e){this.clearContent();if(!e||!e.length)return;if(g.data!=e)g.data=e;if(p.columns){g.selectBox.table.headrow=$("<tr class='l-table-headerow'><td width='18px'></td></tr>");g.selectBox.table.append(g.selectBox.table.headrow);g.selectBox.table.addClass("l-box-select-grid");for(var t=0;t<p.columns.length;t++){var l=$("<td columnindex='"+t+"' columnname='"+p.columns[t].name+"'>"+p.columns[t].header+"</td>");if(p.columns[t].width){l.width(p.columns[t].width)}g.selectBox.table.headrow.append(l)}}for(var i=0;i<e.length;i++){var a=e[i][p.valueField];var n=e[i][p.textField];if(!p.columns){$("table.l-table-checkbox",g.selectBox).append("<tr value='"+a+"'><td style='width:18px;'  index='"+i+"' value='"+a+"' text='"+n+"' ><input type='checkbox' /></td><td index='"+i+"' value='"+a+"' align='left'>"+n+"</td>");$("table.l-table-nocheckbox",g.selectBox).append("<tr value='"+a+"'><td index='"+i+"' value='"+a+"' align='left'>"+n+"</td>")}else{var s=$("<tr value='"+a+"'><td style='width:18px;'  index='"+i+"' value='"+a+"' text='"+n+"' ><input type='checkbox' /></td></tr>");$("td",g.selectBox.table.headrow).each(function(){var t=$(this).attr("columnname");if(t){var l=$("<td>"+e[i][t]+"</td>");s.append(l)}});g.selectBox.table.append(s)}}if(p.isShowCheckBox&&$.fn.ligerCheckBox){$("table input:checkbox",g.selectBox).ligerCheckBox()}$(".l-table-checkbox input:checkbox",g.selectBox).change(function(){if(this.checked&&p.onBeforeSelect){var e=null;if($(this).parent().get(0).tagName.toLowerCase()=="div"){e=$(this).parent().parent()}else{e=$(this).parent()}if(e!=null&&!p.onBeforeSelect(e.attr("value"),e.attr("text"))){g.selectBox.slideToggle("fast");return false}}if(!p.isMultiSelect){if(this.checked){$("input:checked",g.selectBox).not(this).each(function(){this.checked=false;$(".l-checkbox-checked",$(this).parent()).removeClass("l-checkbox-checked")});g.selectBox.slideToggle("fast")}}po.checkboxUpdateValue()});$("table.l-table-nocheckbox td",g.selectBox).hover(function(){$(this).addClass("l-over")},function(){$(this).removeClass("l-over")});po.addClickEven();po.dataInit()},setTree:function(e){this.clearContent();g.selectBox.table.remove();if(e.checkbox!=false){e.onCheck=function(){var e=g.treeManager.getChecked();var t=[];var l=[];$(e).each(function(e,i){if(p.treeLeafOnly&&i.data.children)return;t.push(i.data[p.valueField]);l.push(i.data[p.textField])});po.changeValue(t.join(p.split),l.join(p.split))}}else{e.onSelect=function(e){if(p.treeLeafOnly&&e.data.children)return;var t=e.data[p.valueField];var l=e.data[p.textField];po.changeValue(t,l)};e.onCancelSelect=function(e){po.changeValue("","",true)}}e.onAfterAppend=function(e,t){if(!g.treeManager)return;var l=null;if(p.initValue)l=p.initValue;else if(g.valueField.val()!="")l=g.valueField.val();g.selectValueByTree(l)};g.tree=$("<ul></ul>");$("div:first",g.selectBox).append(g.tree);g.tree.ligerTree(e);g.treeManager=g.tree.ligerGetTreeManager()},selectValueByTree:function(e){if(e!=null){var t="";var l=e.toString().split(p.split);$(l).each(function(e,i){g.treeManager.selectNode(i.toString());t+=g.treeManager.getTextByID(i);if(e<l.length-1)t+=p.split});po.changeValue(e,t,true)}},setGrid:function(e){this.clearContent();g.selectBox.table.remove();g.grid=$("div:first",g.selectBox);if(e.checkbox!=false){e.onCheckAllRow=e.onCheckRow=function(){var e=g.gridManager.getCheckedRows();var t=[];var l=[];$(e).each(function(e,i){t.push(i[p.valueField]);l.push(i[p.textField])});po.changeValue(t.join(p.split),l.join(p.split))}}else{e.onSelectRow=function(e,t,l){var i=e[p.valueField];var a=e[p.textField];po.changeValue(i,a)};e.onUnSelectRow=function(e,t,l){po.changeValue("","")}}e.onAfterShowData=function(){if(!g.gridManager)return;if(!p.initValue)return false;var t=p.initValue.split(p.split);for(var l in t)g.gridManager.selectRow(e.pkName,t[l]);var i=p.grid.checkbox?g.gridManager.getCheckedRows():[g.gridManager.getSelectedRow()];var a=[],n=[];for(var s in i){a.push(i[s][p.valueField]);n.push(i[s][p.textField])}po.changeValue(a.join(p.split),n.join(p.split))};e.width="100%";e.height="100%";e.heightDiff=-2;e.InWindow=false;g.grid.ligerGrid(e);g.gridManager=g.grid.ligerGetGridManager();po.onEndResize=function(){g.gridManager&&g.gridManager.setHeight(g.selectBox.height()-2)}},data:p.data,inputText:null,select:null,textFieldID:"",valueFieldID:"",valueField:null};var po={dataInit:function(){var e=null;if(p.initValue!=undefined&&p.initValue!=null&&p.initText!=undefined&&p.initText!=null){po.changeValue(p.initValue,p.initText)}if(p.initValue!=undefined&&p.initValue!=null){e=p.initValue;var t=g.findTextByValue(e);po.changeValue(e,t)}else if(p.initText!=undefined&&p.initText!=null){e=g.findValueByText(p.initText);po.changeValue(e,p.initText)}else if(g.valueField.val()!=""){e=g.valueField.val();var t=g.findTextByValue(e);po.changeValue(e,t)}if(!p.isShowCheckBox&&e!=null){$("table tr",g.selectBox).find("td:first").each(function(){if(e==$(this).attr("value")){$(this).addClass("l-selected")}})}if(p.isShowCheckBox&&e!=null){$(":checkbox",g.selectBox).each(function(){var t=null;var l=$(this);if(l.parent().get(0).tagName.toLowerCase()=="div"){t=l.parent().parent()}else{t=l.parent()}if(t==null)return;var i=e.toString().split(p.split);$(i).each(function(e,i){if(i==t.attr("value")){$(".l-checkbox",t).addClass("l-checkbox-checked");l[0].checked=true}})})}},changeValue:function(e,t,l){g.valueField.val(e);g.inputText.val(t);g.selectedValue=e;g.selectedText=t;g.inputText.trigger("change").focus();if(p.onSelected&&l==undefined)p.onSelected(e,t)},checkboxUpdateValue:function(){var e="";var t="";$("input:checked",g.selectBox).each(function(){var l=null;if($(this).parent().get(0).tagName.toLowerCase()=="div"){l=$(this).parent().parent()}else{l=$(this).parent()}if(!l)return;e+=l.attr("value")+p.split;t+=l.attr("text")+p.split});if(e.length>0)e=e.substr(0,e.length-1);if(t.length>0)t=t.substr(0,t.length-1);po.changeValue(e,t)},addClickEven:function(){$(".l-table-nocheckbox td",g.selectBox).click(function(){if(p.onBeforeSelect&&!p.onBeforeSelect($(this).attr("value"),$(this).html())){if(p.slide)g.selectBox.slideToggle("fast");else g.selectBox.hide();return false}if($(this).hasClass("l-selected")){if(p.slide)g.selectBox.slideToggle("fast");else g.selectBox.hide();return}$(".l-selected",g.selectBox).removeClass("l-selected");$(this).addClass("l-selected");if(g.select){if(g.select[0].selectedIndex!=$(this).attr("index")){var e=parseInt($(this).attr("index"));g.select[0].selectedIndex=e;g.select.trigger("change")}}if(p.slide){g.boxToggling=true;g.selectBox.hide("fast",function(){g.boxToggling=false})}else g.selectBox.hide();po.changeValue($(this).attr("value"),$(this).html())})},toggleSelectBox:function(e){var t=g.wrapper.height();g.boxToggling=true;if(e){if(p.slide){g.selectBox.slideToggle("fast",function(){g.boxToggling=false})}else{g.selectBox.hide();g.boxToggling=false}}else{var l=g.wrapper.offset().top-$(window).scrollTop();var i=g.selectBox.height()+t+4;if(l+i>$(window).height()&&l>i){g.selectBox.css("marginTop",-1*(g.selectBox.height()+t+5))}if(p.slide){g.selectBox.slideToggle("fast",function(){g.boxToggling=false;if(!p.isShowCheckBox&&$("td.l-selected",g.selectBox).length>0){var e=$("td.l-selected",g.selectBox).offset().top-g.selectBox.offset().top;$(".l-box-select-inner",g.selectBox).animate({scrollTop:e})}})}else{g.selectBox.show();g.boxToggling=false;if(!g.tree&&!g.grid&&!p.isShowCheckBox&&$("td.l-selected",g.selectBox).length>0){var a=$("td.l-selected",g.selectBox).offset().top-g.selectBox.offset().top;$(".l-box-select-inner",g.selectBox).animate({scrollTop:a})}}}g.isShowed=g.selectBox.is(":visible")}};if(this.tagName.toLowerCase()=="input"){this.readOnly=true;g.inputText=$(this);g.textFieldID=this.id;g.inputText[0].id=g.inputText[0].name=g.inputText.attr("id")+"_txt"}else if(this.tagName.toLowerCase()=="select"){$(this).addClass("l-hidden");g.select=$(this);p.isMultiSelect=false;p.isShowCheckBox=false;g.textFieldID=this.id+"_txt";g.inputText=$('<input type="text" readonly="true"/>');g.inputText.attr("id",g.textFieldID).insertAfter($(this))}else{return}if(g.inputText[0].name==undefined)g.inputText[0].name=g.textFieldID;g.valueField=null;if(p.valueFieldID){g.valueField=$("#"+p.valueFieldID+":input");if(g.valueField.length==0)g.valueField=$('<input type="hidden"/>');g.valueField[0].id=g.valueField[0].name=p.valueFieldID}else{g.valueField=$('<input type="hidden"/>');g.valueField[0].id=g.valueField[0].name=g.textFieldID}if(g.valueField[0].name==undefined)g.valueField[0].name=g.valueField[0].id;g.link=$('<div class="l-trigger"><div class="l-trigger-icon"></div></div>');g.selectBox=$('<div class="l-box-select"><div><table width="100%" cellpadding="0" cellspacing="0" border="0" class="l-box-select-table"></table></div></div>');g.selectBox.table=$("table:first",g.selectBox);g.wrapper=g.inputText.wrap('<div class="l-text l-text-combobox"></div>').parent();if(p.showRoot){g.clear=g.wrapper.append('<div class="l-text-clear"><a>'+p.rootText+"</a></div>").find(".l-text-clear")}g.wrapper.append('<div class="l-text-l"></div><div class="l-text-r"></div>');g.wrapper.append(g.link).after(g.selectBox).after(g.valueField);g.inputText.wrap('<div class="l-input-margin"></div>');g.inputText.addClass("l-text-field");if(p.width){g.wrapper.css({width:p.width});g.inputText.css({width:p.width-20})}if(p.height){g.wrapper.height(p.height);g.inputText.height(p.height-2);g.link.height(p.height-4)}if(p.isShowCheckBox&&!g.select){$("table",g.selectBox).addClass("l-table-checkbox")}else{p.isShowCheckBox=false;$("table",g.selectBox).addClass("l-table-nocheckbox")}if(p.resize&&$.fn.ligerResizable){g.selectBox.ligerResizable({handles:"se,s",onStartResize:function(){g.resizing=true;p.onStartResize&&onStartResize()},onEndResize:function(){g.resizing=false;po.onEndResize&&po.onEndResize();p.onEndResize&&p.onEndResize()}});g.selectBox.append("<div class='l-btn-nw-drop'></div>")}g.link.hover(function(){this.className="l-trigger-hover"},function(){this.className="l-trigger"}).mousedown(function(){this.className="l-trigger-pressed"}).mouseup(function(){this.className="l-trigger-hover"}).click(function(){if(p.onBeforeOpen&&p.onBeforeOpen()==false)return false;po.toggleSelectBox(g.selectBox.is(":visible"))});g.inputText.click(function(){if(p.onBeforeOpen&&p.onBeforeOpen()==false)return false;po.toggleSelectBox(g.selectBox.is(":visible"))}).blur(function(){g.wrapper.removeClass("l-text-focus")}).focus(function(){g.wrapper.addClass("l-text-focus")});g.wrapper.hover(function(){g.wrapper.addClass("l-text-over")},function(){g.wrapper.removeClass("l-text-over")});if(p.showRoot){g.clear.click(function(){if(g.treeManager){var e=g.treeManager.tree;$(".l-checkbox-checked",e).each(function(){$(this).removeClass("l-checkbox-checked").addClass("l-checkbox-unchecked")});$(".l-selected",e).each(function(){$(this).removeClass("l-selected")})}else if(g.gridManager){var t=g.gridManager.getCheckedRowObjs();for(var l in t){$(t[l]).removeClass("l-checked")}var i=g.gridManager.gridbody;$(".l-grid-hd-cell-checkbox",i.prev()).parent("tr").removeClass("l-checked")}else{$(".l-selected",g.selectBox).each(function(){$(this).removeClass("l-selected")})}po.changeValue(p.rootId,"")})}g.resizing=false;g.selectBox.hover(null,function(e){if(p.hideOnLoseFocus&&g.selectBox.is(":visible")&&!g.boxToggling&&!g.resizing){po.toggleSelectBox(true)}});if(p.selectBoxWidth){g.selectBox.width(p.selectBoxWidth)}else{g.selectBox.css("width",g.wrapper.css("width"))}var itemsleng=$("tr",g.selectBox.table).length;if(!p.selectBoxHeight&&itemsleng<8)p.selectBoxHeight=itemsleng*30;if(p.selectBoxHeight){g.selectBox.height(p.selectBoxHeight)}g.bulidContent();if(p.render)g.inputText.val(p.render());if(this.id==undefined)this.id="LigerUI_"+(new Date).getTime();LigerUIManagers[this.id+"_ComboBox"]=g;this.usedComboBox=true});if(this.length==0)return null;if(this.length==1)return LigerUIManagers[this[0].id+"_ComboBox"];var managers=[];this.each(function(){managers.push(LigerUIManagers[this.id+"_ComboBox"])});return managers}})(jQuery);