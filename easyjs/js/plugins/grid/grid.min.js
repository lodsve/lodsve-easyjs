var ie6=navigator.appName=="Microsoft Internet Explorer"&&parseInt(navigator.appVersion)==4&&navigator.appVersion.indexOf("MSIE 6.0")!=-1;if(typeof LigerUIManagers=="undefined")LigerUIManagers={};(function($){$.fn.ligerGetGridManager=function(){return LigerUIManagers[this[0].id+"_Grid"]};$.ligerDefaults=$.ligerDefaults||{};$.ligerDefaults.Grid={title:null,width:"auto",columnWidth:120,resizable:true,url:false,usePager:true,page:1,total:1,pageSize:10,pageSizeOptions:[10,20,30,40,50],parms:[],columns:[],minColToggle:1,dataType:"server",dataAction:"server",showTableToggleBtn:false,switchPageSizeApplyComboBox:false,allowAdjustColWidth:false,checkbox:false,allowHideColumn:true,enabledEdit:false,isScroll:true,onDragCol:null,onToggleCol:null,onChangeSort:null,onSuccess:null,onDblClickRow:null,onSelectRow:null,onUnSelectRow:null,onBeforeCheckRow:null,onCheckRow:null,onBeforeCheckAllRow:null,onCheckAllRow:null,onBeforeShowData:null,onAfterShowData:null,onError:null,onSubmit:null,dateFormat:"hh:mm yyyy-MM-dd",InWindow:true,statusName:"__status",method:"post",fixedCellHeight:true,heightDiff:0,cssClass:null,root:"Rows",record:"Total",pageParmName:"page",pagesizeParmName:"pagesize",sortnameParmName:"sortname",sortorderParmName:"sortorder",onReload:null,onToFirst:null,onToPrev:null,onToNext:null,onToLast:null,allowUnSelectRow:false,dblClickToEdit:false,alternatingRow:true,mouseoverRowCssClass:"l-grid-row-over",enabledSort:true,rowAttrRender:null,groupColumnName:null,groupColumnDisplay:"分组",totalRender:null,delayLoad:false,where:null,selectRowButtonOnly:false,onAfterAddRow:null,onBeforeEdit:null,onBeforeSubmitEdit:null,onAfterEdit:null,onLoading:null,onLoaded:null,onContextmenu:null,onRClickToSelect:true,dblClickRow:null,tree:null,isChecked:null,renderDate:function(value){var da;if(!value)return null;if(typeof value=="object"){return value}if(value.indexOf("Date")>-1){da=eval("new "+value.replace("/","","g").replace("/","","g"))}else{da=eval('new Date("'+value+'");')}return da}};$.ligerDefaults.GridString={errorMessage:"发生错误",pageStatMessage:"显示记录从{from}到{to}，总数 {total} 条 。每页显示记录数：{pagesize}",pageTextMessage:"Page",loadingMessage:"加载中...",findTextMessage:"查找",noRecordMessage:"没有符合条件的记录存在",isContinueByDataChanged:"数据已经改变,如果继续将丢失数据,是否继续?"};$.ligerAddGrid=function(e,t){if(e.usedGrid)return;t.cssClass&&$(e).addClass(t.cssClass);$(e).addClass("l-panel");var r=[];r.push("        <div class='l-panel-header'><span class='l-panel-header-text'></span></div>");r.push("                    <div class='l-grid-loading'></div>");r.push("                    <div class='l-grid-editor'></div>");r.push("        <div class='l-panel-bwarp'>");r.push("            <div class='l-panel-body'>");r.push("                <div class='l-grid'>");r.push("                    <div class='l-grid-dragging-line'></div>");r.push("                    <div class='l-grid-header'>");r.push("                        <div class='l-grid-header-inner'><table class='l-grid-header-table' cellpadding='0' cellspacing='0'><tbody><tr></tr></tbody></table></div>");r.push("                    </div>");r.push("                    <div class='l-grid-body l-scroll'>");r.push("                    </div>");r.push("                 </div>");r.push("              </div>");r.push("         </div>");r.push("         <div class='l-panel-bar'>");r.push("            <div class='l-panel-bbar-inner'>");r.push("            <div class='l-bar-group l-bar-selectpagesize'></div>");r.push("                <div class='l-bar-separator'></div>");r.push("                <div class='l-bar-group'>");r.push("                    <div class='l-bar-button l-bar-btnfirst'><span></span></div>");r.push("                    <div class='l-bar-button l-bar-btnprev'><span></span></div>");r.push("                </div>");r.push("                <div class='l-bar-separator'></div>");r.push("                <div class='l-bar-group'><span class='pcontrol'> <input id='curPage' type='text' size='4' value='1' style='width:20px' maxlength='3'/> / <span></span></span></div>");r.push("                <div class='l-bar-separator'></div>");r.push("                <div class='l-bar-group'>");r.push("                     <div class='l-bar-button l-bar-btnnext'><span></span></div>");r.push("                    <div class='l-bar-button l-bar-btnlast'><span></span></div>");r.push("                </div>");r.push("                <div class='l-bar-separator'></div>");r.push("                <div class='l-bar-group'>");r.push("                     <div class='l-bar-button l-bar-btnload'><span></span></div>");r.push("                </div>");r.push("                <div class='l-bar-separator'></div>");r.push("                <div class='l-bar-group l-bar-right'><span class='l-bar-text'></span></div>");r.push("                <div class='l-clear'></div>");r.push("            </div>");r.push("         </div>");$(e).html(r.join(""));var a={loadData:function(e){var r=null;var i=true;if(typeof e=="function"){r=e;i=false}else if(typeof e=="boolean"){i=e}else if(typeof e=="object"&&e){i=false;t.dataType="local";t.data=e}if(!t.newPage)t.newPage=1;if(t.dataAction=="server"){if(!t.sortOrder)t.sortOrder="asc"}var n=[];if(t.parms&&t.parms.length){$(t.parms).each(function(){n.push({name:this.name,value:this.value})})}if(t.dataAction=="server"){if(t.usePager){n.push({name:t.pageParmName,value:t.newPage});n.push({name:t.pagesizeParmName,value:t.pageSize})}if(t.sortName){n.push({name:t.sortnameParmName,value:t.sortName});n.push({name:t.sortorderParmName,value:t.sortOrder})}}$(".l-bar-btnload span",a.toolbar).addClass("l-disabled");a.loading=true;if(t.dataType=="local"){a.data=$.extend({},t.data);a.filteredData=$.extend({},a.data);if(r)a.filteredData[t.root]=l.searchData(a.filteredData[t.root],r);if(t.usePager)a.currentData=l.getCurrentPageData(a.filteredData);else{a.currentData=$.extend({},a.filteredData)}l.showData(a.currentData)}else if(t.dataAction=="local"&&!i){if(a.data&&a.data[t.root]){a.filteredData=$.extend({},a.data);if(r)a.filteredData[t.root]=l.searchData(a.filteredData[t.root],r);a.currentData=l.getCurrentPageData(a.filteredData);l.showData(a.currentData)}}else{if(t.onLoading)t.onLoading(a);else{if(!ie6){a.gridloading.show()}}setTimeout(function(){a.loadServerData(n,r)},10)}},loadServerData:function(e,r){$.ajax({type:t.method,url:t.url,data:e,async:false,dataType:"json",beforeSend:function(){},success:function(e){if(t.onSuccess)t.onSuccess(e,a);if(!e||!e[t.root]||!e[t.root].length){a.currentData=a.data={};a.currentData[t.root]=a.data[t.root]=[];a.currentData[t.record]=a.data[t.record]=0}a.data=$.extend({},e);for(var i in a.data[t.root]){if(a.data[t.root][i][t.statusName]==undefined)a.data[t.root][i][t.statusName]=""}if(t.dataAction=="server"){a.currentData=a.data}else{a.filteredData=$.extend({},a.data);if(r)a.filteredData[t.root]=l.searchData(a.filteredData[t.root],r);a.currentData=l.getCurrentPageData(a.filteredData)}setTimeout(function(){l.showData(a.currentData)},10)},complete:function(){if(t.onLoaded){t.onLoaded(a)}else{setTimeout(function(){a.gridloading.hide()},10)}},error:function(e,r,i){a.currentData=a.data={};a.currentData[t.root]=a.data[t.root]=[];a.currentData[t.record]=a.data[t.record]=0;a.gridloading.hide();$(".l-bar-btnload span",a.toolbar).removeClass("l-disabled");try{if(t.onError)t.onError(e,r,i)}catch(l){}}})},setOptions:function(e){$.extend(t,e);if(e.data){a.data=e.data;t.dataType="local"}},stringToDate:function(e){if(e instanceof Date)return e;var t=new Date;try{t.setYear(parseInt(e.substring(0,4),10));t.setMonth(parseInt(e.substring(5,7)-1,10));t.setDate(parseInt(e.substring(8,10),10));if(e.length>10){t.setHours(parseInt(e.substring(11,13),10));t.setMinutes(parseInt(e.substring(14,16),10))}if(e.length>16){t.setSeconds(parseInt(e.substring(17,19),10))}}catch(r){}return t},getFormatDate:function(e,t){if(isNaN(e))return null;var r=t;var a={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};if(/(y+)/.test(r)){r=r.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length))}for(var i in a){if(new RegExp("("+i+")").test(r)){r=r.replace(RegExp.$1,RegExp.$1.length==1?a[i]:("00"+a[i]).substr((""+a[i]).length))}}return r},endEdit:function(){if(!a.grideditor.editingCell)return;var e=a.grideditor.editingCell;var r=a.grideditor.editingValue;a.grideditor.html("").hide();var i=$(e).parent();var l=i.attr("rowindex");var n=i.attr("rowid");var o=$(e).attr("columnindex");var d=$(e).attr("columnname");var s=a.columns[o];var u=a.getRow(n);var c={record:u,value:r,column:s,columnname:d,columnindex:o,rowindex:l,rowObj:i[0],cellObj:e};if(t.onAfterEdit)t.onAfterEdit(c);a.grideditor.editingCell=null;a.grideditor.editingValue=null},deleteSelectedRow:function(){if(t.checkbox){$("tbody:first > tr.l-checked",a.gridbody).each(function(){a.deleteRow(this)})}else{var e=$("tbody:first > tr.l-selected",a.gridbody);if(e.length==0)return;a.deleteRow(e[0])}},deleteRow:function(e){var r=a.getRowObj(e);if(!r)return;a.popup.hide();a.endEdit();var i=$(r).attr("rowid");if(t.tree&&a.hasChildren(r)){$("tbody:first > tr[parentrowid="+i+"]",a.gridbody).each(function(){a.deleteRow(this)})}$(r).remove();a.deleteData(i);a.isDataChanged=true},deleteData:function(e){a.records[e][t.statusName]="delete"},updateCell:function(e,r,i){var n;var o;var d;if(typeof e=="number"){n=e;o=a.columns[n];d=$("td[columnindex="+n+"]",s)[0]}else if(typeof e=="string"){var s=a.getRowObj(i);d=$("td[columnname="+e+"]",s)[0];n=$(d).attr("columnindex");o=a.columns[n]}else{d=e;n=$(d).attr("columnindex");o=a.columns[n]}var u=$(d).parent();var c=u.attr("rowindex");var g=u.attr("rowid");var f=a.getRow(g);a.updateData(d,r);var h=l.getCellContent(f,c,r,o,t.tree,u.attr("treelevel"));$(".l-grid-row-cell-inner:first",d).html(h)},updateData:function(e,r,i){if(typeof e=="string"){var l=$(i).attr("rowindex");var n=$(i).attr("rowid");var o=a.getRow(n);o[e]=r;if(o[t.statusName]!="add")o[t.statusName]="update";a.isDataChanged=true;return}var d=$(e).attr("columnindex");var s=a.columns[d];if(!s)return;var u=s.name;if(!u)return;var c=$(e).parents(".l-grid-row:eq(0)");var l=c.attr("rowindex");var o=a.currentData[t.root][l];if(s.type=="int")o[u]=parseInt(r);else if(s.type=="float")o[u]=parseFloat(r);else if(s.type=="date"){var g=t.renderDate(r);if(!g||isNaN(g))g=a.stringToDate(r);o[u]=g}else o[u]=r;if(o[t.statusName]!="add")o[t.statusName]="update";a.isDataChanged=true},addRow:function(e,r,i,n){if(!e)e={};var o,d,s,u,c;if(n){s=a.getRowObj(n);o=parseInt($(s).attr("treelevel"))+1;d=$(s).attr("rowid");u=a.getRow(d);c=$(".l-grid-tree-link:first",s).hasClass("l-grid-tree-link-open")}var g=u?u[t.tree.childrenName].length:a.currentData[t.root].length;var f=a.getRowObj(r);var h=f?parseInt($(f).attr("rowindex"))+(i?0:1):g;var p=l.getHtmlFromData([e],t.tree,o?o:1,d);var v=$(p);v.attr("rowindex",h).removeClass("l-grid-row-last");if(n&&!c)v.hide();if(h==g){if(u)u[t.tree.childrenName][h]=e;else a.currentData[t.root][h]=e;if(!t.usePager&&!a.isTotalSummary()){$("tbody:first > .l-grid-row:last",a.gridbody).removeClass("l-grid-row-last");v.addClass("l-grid-row-last")}}else{if(u)u[t.tree.childrenName].splice(h,0,e);else a.currentData[t.root].splice(h,0,e);var m=t.tree?"tr[parentrowid="+d+"][treelevel="+o+"]":"tr";$(f).nextAll(m).add(f).each(function(){var e=$(this).attr("rowindex");if(e>=h)$(this).attr("rowindex",parseInt(e)+1)})}if($("tbody",a.gridbody).length==0){a.gridbody.html('<div class="l-grid-body-inner"><table class="l-grid-body-table" cellpadding=0 cellspacing=0><tbody></tbody></table></div>')}if(f!=undefined){if(i)$(f).before(v);else $(f).after(v)}else{$("tbody:first",a.gridbody).append(v)}e[t.statusName]="add";l.setRowEven(v[0]);a.isDataChanged=true;t.total=t.total?t.total+1:1;t.pageCount=Math.ceil(t.total/t.pageSize);l.buildPager();if(t.onAfterAddRow)t.onAfterAddRow(v,e);return v},updateRow:function(e,r){var i=a.getRow(e);a.isDataChanged=true;if(r){for(var l in r){if(l==t.statusName)continue;i[l]=r[l];var n=$("> .l-grid-row-cell[columnname="+l+"]",e);if(n.length==0)continue;var o=n.attr("columnindex");var d=a.columns[o];a.updateCell(n,r[l])}i[t.statusName]="update"}return i},getData:function(){if(a.currentData==null)return null;return a.currentData[t.root]},getColumn:function(e){for(i=0;i<a.columns.length;i++){if(a.columns[i].name==e){return a.columns[i]}}return null},getColumnType:function(e){for(i=0;i<a.columns.length;i++){if(a.columns[i].name==e){if(a.columns[i].type)return a.columns[i].type;return"string"}}return null},isTotalSummary:function(){for(var e=0;e<a.columns.length;e++){if(a.columns[e].totalSummary)return true}return false},getMulHeaderLevel:function(){if(!t.columns.length)return 1;var e=0;var r=t.columns[0];while(r){e++;if(!r.columns||!r.columns.length)break;r=r.columns[0]}return e},getColumns:function(e){if(e<=1)return t.columns;return a.getLevelColumns({columns:t.columns},0,e)},getLevelColumns:function(e,t,r){if(t==r)return[e];var i=[];for(var l=0;e.columns&&l<e.columns.length;l++){var n=a.getLevelColumns(e.columns[l],t+1,r);$(n).each(function(){i.push(this)})}return i},getMulHeaders:function(e){var t=function(e){if(!e.columns||!e.columns.length)return 1;var r=0;for(var a=0;a<e.columns.length;a++){r+=t(e.columns[a])}return r};var r=a.getColumns(e);var i=[];for(var l=0;l<r.length;l++){i.push({display:r[l]["display"],number:t(r[l])})}return i},changeSort:function(e,r){if(a.loading)return true;if(t.dataAction=="local"){var i=a.getColumnType(e);if(!a.sortedData)a.sortedData=$.extend({},a.filteredData);if(t.sortName==e){a.sortedData[t.root].reverse()}else{a.sortedData[t.root].sort(function(t,r){return l.compareData(t,r,e,i)})}if(t.usePager)a.currentData=l.getCurrentPageData(a.sortedData);else a.currentData=a.sortedData;l.showData(a.currentData)}t.sortName=e;t.sortOrder=r;if(t.dataAction=="server"){a.loadData(t.where)}},changePage:function(e){if(a.loading)return true;if(a.isDataChanged&&!confirm(t.isContinueByDataChanged))return false;switch(e){case"first":if(t.page==1)return;t.newPage=1;break;case"prev":if(t.page==1)return;if(t.page>1)t.newPage=parseInt(t.page)-1;break;case"next":if(t.page>=t.pageCount)return;t.newPage=parseInt(t.page)+1;break;case"last":if(t.page>=t.pageCount)return;t.newPage=t.pageCount;break;case"input":var r=parseInt($(".pcontrol input",a.toolbar).val());if(isNaN(r))r=1;if(r<1)r=1;else if(r>t.pageCount)r=t.pageCount;$(".pcontrol input",a.toolbar).val(r);t.newPage=r;break}if(t.newPage==t.page)return false;if(t.newPage==1){$(".l-bar-btnfirst span",a.toolbar).addClass("l-disabled");$(".l-bar-btnprev span",a.toolbar).addClass("l-disabled")}else{$(".l-bar-btnfirst span",a.toolbar).removeClass("l-disabled");$(".l-bar-btnprev span",a.toolbar).removeClass("l-disabled")}if(t.newPage==t.pageCount){$(".l-bar-btnlast span",a.toolbar).addClass("l-disabled");$(".l-bar-btnnext span",a.toolbar).addClass("l-disabled")}else{$(".l-bar-btnlast span",a.toolbar).removeClass("l-disabled");$(".l-bar-btnnext span",a.toolbar).removeClass("l-disabled")}if(t.onChangePage)t.onChangePage(t.newPage);if(t.dataAction=="server"){a.loadData(t.where)}else{a.currentData=l.getCurrentPageData(a.filteredData);l.showData(a.currentData)}},getCheckedRows:function(){var e=$("tbody:first > .l-checked",a.gridbody);var t=[];$("tbody:first > .l-checked",a.gridbody).each(function(e,r){var i=$(r).attr("rowid");t.push(a.getRow(i))});return t},getSelectedRow:function(){var e=$("tbody:first > .l-selected",a.gridbody);var t=e.attr("rowid");return a.getRow(t)},getCheckedRowObjs:function(){return $("tbody:first > .l-checked",a.gridbody).get()},getSelectedRowObj:function(){var e=$("tbody:first > .l-selected",a.gridbody);if(e.length==0)return null;return e[0]},getRowObj:function(e){if(typeof e=="string"||typeof e=="number"){return $("tbody:first > .l-grid-row[rowid="+e+"]",a.gridbody).get(0)}else if(typeof e=="object"){if(!e)return null;if(typeof e.nodeType!="undefined"&&e.nodeType==1)return e;else{for(var t in a.records){if(a.records[t]==e)return $("tbody:first > .l-grid-row[rowid="+t+"]",a.gridbody).get(0)}}}return null},getRowByKeyValue:function(e,t){if(!e||!t)return null;for(var r in a.records){if(a.records[r][e]==t)return $("tbody:first > .l-grid-row[rowid="+r+"]",a.gridbody).get(0)}return null},getRow:function(e){if(typeof e=="string"||typeof e=="number"){return a.records[parseInt(e)]}else if(typeof e=="object"){if(!e)return null;if(typeof e.nodeType!="undefined"&&e.nodeType==1)return a.records[$(e).attr("rowid")];else return e}return null},toggleCol:function(e,t){var r=null;var i=-1;if(typeof e=="number"){i=e;r=$(".l-grid-hd-cell[columnindex='"+e+"']",a.gridheader)}else if(typeof e=="string"){r=$(".l-grid-hd-cell[columnname='"+e+"']",a.gridheader);if(!r)return;i=r.attr("columnindex")}if(!r)return;if(t){r.show();$(".l-grid-row-cell[columnindex='"+i+"']",a.gridbody).show()}else{r.hide();$(".l-grid-row-cell[columnindex='"+i+"']",a.gridbody).hide()}},changeHeaderText:function(e,r){var i=null;var l=-1;if(typeof e=="number"){l=e;i=$(".l-grid-hd-cell[columnindex='"+e+"']",a.gridheader)}else if(typeof e=="string"){i=$(".l-grid-hd-cell[columnname='"+e+"']",a.gridheader);if(!i)return;l=i.attr("columnindex")}if(!i)return;$(".l-grid-hd-cell-text",i).html(r);if(t.allowHideColumn){$(":checkbox[columnindex="+l+"]",a.popup).parent().next().html(r)}},getParent:function(e){var t=a.getRowObj(e);if(!t)return;var r=$(t).attr("parentrowid");if(r==undefined)return null;return a.getRow(r)},getChidren:function(e){if(!t.tree)return null;var r=a.getRow(e);if(!r)return null;return r[t.tree.childrenName]},isLeaf:function(e){var t=a.getRowObj(e);if(!t)return;return!$("> td > div > .l-grid-tree-space:last",t).hasClass("l-grid-tree-link")},hasChildren:function(e){var t=a.getRowObj(e);if(!t)return;var r=$(t).attr("treelevel");var i=$(t).next(".l-grid-row");if(i.length==0)return false;var l=i.attr("treelevel");return parseInt(r)<parseInt(l)},appendRow:function(e,t,r,i){var l=a.getRowObj(t);if(!t){a.addRow(e);return}if(r){a.addRow(e,r,i?true:false,l);return}var n=$(l).attr("rowid");var o=$(l).nextAll("tr[parentrowid="+n+"]").get();if(!o)return;if(o.length==0)a.addRow(e,l,false,l);else a.addRow(e,o[o.length-1],false,l)},upgrade:function(e){if(!e||!t.tree)return;var r=a.getRow(e);var i=a.getRowObj(e);if(!r[t.tree.childrenName])r[t.tree.childrenName]=[];$("> td > div > .l-grid-tree-space:last",e).addClass("l-grid-tree-link l-grid-tree-link-open")},demotion:function(e){if(!e||!t.tree)return;var r=a.getRow(e);var i=a.getRowObj(e);var l=$(i).attr("rowid");$("> td > div > .l-grid-tree-space:last",e).removeClass("l-grid-tree-link l-grid-tree-link-open l-grid-tree-link-close");if(a.hasChildren(i)){$("tbody:first > tr[parentrowid="+l+"]",a.gridbody).each(function(){a.deleteRow(this)})}},collapse:function(e){var t=a.getRowObj(e);var r=$(".l-grid-tree-link",t);if(r.hasClass("l-grid-tree-link-close"))return;a.toggle(e)},expand:function(e){var t=a.getRowObj(e);var r=$(".l-grid-tree-link",t);if(r.hasClass("l-grid-tree-link-open"))return;a.toggle(e)},toggle:function(e){var t=a.getRowObj(e);var r=$(t);var i=r.attr("treelevel");var l=$(".l-grid-tree-link",r);var n=true;if(l.hasClass("l-grid-tree-link-close")){l.removeClass("l-grid-tree-link-close").addClass("l-grid-tree-link-open")}else{n=false;l.addClass("l-grid-tree-link-close").removeClass("l-grid-tree-link-open")}var o=r.next(".l-grid-treerow");while(true){if(o.length==0)break;var d=o.attr("treelevel");if(d<=i)break;if(n){$(".l-grid-tree-link",o).removeClass("l-grid-tree-link-close").addClass("l-grid-tree-link-open");o.show()}else{$(".l-grid-tree-link",o).removeClass("l-grid-tree-link-open").addClass("l-grid-tree-link-close");o.hide()}o=o.next(".l-grid-treerow")}},getClickRow:function(e){var t,r;var i=$(e);if(e.tagName.toLowerCase()=="td"){t=i.parent().attr("rowid")}else if(e.tagName.toLowerCase()=="div"&&($(e).hasClass("l-grid-tree-space")||$(e).hasClass("l-grid-sub-arrow"))){t=i.parent().parent().parent().parent().attr("rowid")}else if(e.tagName.toLowerCase()=="div"){t=i.parent().parent().attr("rowid")}else if(e.tagName.toLowerCase()=="img"){t=i.parent().parent().parent().parent().parent().attr("rowid")}else{t=i.parent().parent().parent().attr("rowid")}r=a.getRow(t);return r},selectRow:function(e,r){var i=a.getRowByKeyValue(e,r);$(i).addClass(t.checkbox?"l-checked":"l-selected")}};var l={init:function(){l.initBuildHeader();l.initBuildGridHeader();l.initBuildPopup();l.initHeight();t.delayLoad||a.loadData(t.where);l.initFootbar();a.gridloading.html(t.loadingMessage);l.initEven()},initBuildHeader:function(){if(t.title)$(".l-panel-header-text",a.header).html(t.title);else a.header.hide()},initBuildGridHeader:function(){var e=a.getMulHeaderLevel();for(var r=1;r<=e-1;r++){var i=a.getMulHeaders(r);var l=$("<tr class='l-grid-hd-mul'></tr>");$("tr:last",a.gridheader).before(l);if(t.checkbox){var n=$("<td class='l-grid-hd-cell l-grid-hd-cell-checkbox l-grid-hd-cell-mul'></td>");l.append(n)}if(t.detail&&t.detail.onShowDetail){var o=$("<td class='l-grid-hd-cell l-grid-hd-cell-detail l-grid-hd-cell-mul'></td>");l.append(o)}$(i).each(function(e,t){var r=$("<td class='l-grid-hd-cell l-grid-hd-cell-mul'><div class='l-grid-hd-cell-inner'><span class='l-grid-hd-cell-text'> </span></div></td>");r.attr("colSpan",t.number);$(".l-grid-hd-cell-text",r).html(t.display);l.append(r)})}a.columns=a.getColumns(e);if(e>1)a.gridheader.height(a.gridheader.height()*e);a.headers=[];a.gridtablewidth=0;if(t.checkbox){var n=$("<td class='l-grid-hd-cell l-grid-hd-cell-checkbox'><div class='l-grid-hd-cell-inner'><div class='l-grid-hd-cell-text l-grid-hd-cell-btn-checkbox'></div></div></td>");n.css({width:27});$("tr:last",a.gridheader).append(n);a.headers.push({width:27,ischeckbox:true});a.gridtablewidth+=28}if(t.detail&&t.detail.onShowDetail){var o=$("<td class='l-grid-hd-cell l-grid-hd-cell-detail'><div class='l-grid-hd-cell-inner'><div class='l-grid-hd-cell-text'></div></div></td>");o.css({width:29});$("tr:last",a.gridheader).append(o);a.headers.push({width:29,isdetail:true});a.gridtablewidth+=30}$(a.columns).each(function(e,r){var i=$("<td class='l-grid-hd-cell' columnindex='"+e+"'><div class='l-grid-hd-cell-inner'><span class='l-grid-hd-cell-text'> </span></div></td>");if(e==a.columns.length-1){i.addClass("l-grid-hd-cell-last")}if(r.name)i.attr({columnname:r.name});if(r.isSort!=undefined)i.attr({isSort:r.isSort});if(r.isAllowHide!=undefined)i.attr({isAllowHide:r.isAllowHide});var l="";if(r.display&&r.display!="")l=r.display;else if(r.headerRender)l=r.headerRender(r);else l="&nbsp;";$(".l-grid-hd-cell-text",i).html(l);$("tr:last",a.gridheader).append(i);var n=r.width;if(r.width){n=r.width}else if(r.minWidth){n=r.minWidth}else if(t.columnWidth){n=t.columnWidth}if(!n)n=120;if(typeof n=="string"&&n.indexOf("%")>0){r.width=n=parseInt(parseInt(n)*.01*(a.gridbody.width()-a.columns.length))}i.width(n);a.gridtablewidth+=(parseInt(n)?parseInt(n):0)+1;a.headers.push({width:n,columnname:r.name,columnindex:e,islast:e==a.columns.length-1,isdetail:false})});$("div:first",a.gridheader).width(a.gridtablewidth+40)},initBuildPopup:function(){$("tr:last .l-grid-hd-cell",a.gridheader).each(function(e,t){if($(this).hasClass("l-grid-hd-cell-detail"))return;var r=$(this).attr("isAllowHide");if(r!=undefined&&r.toLowerCase()=="false")return;var i='checked="checked"';var l=$(this).attr("columnindex");var n=$(this).attr("columnname");if(!l||!n)return;var o=$(".l-grid-hd-cell-text",this).html();if(this.style.display=="none")i="";$("tbody",a.popup).append('<tr><td class="l-column-left"><input type="checkbox" '+i+' class="l-checkbox" columnindex="'+l+'"/></td><td class="l-column-right">'+o+"</td></tr>")});$.fn.ligerCheckBox&&$("input:checkbox",a.popup).ligerCheckBox({onBeforeClick:function(e){if(!e.checked)return true;if($("input:checked",a.popup).length<=t.minColToggle)return false;return true}});$(".l-grid-hd-cell",a.gridheader).bind("contextmenu",function(e){if(a.colresize)return true;if(!t.allowHideColumn)return true;var r=$(this).attr("columnindex");if(r==undefined)return true;var i=e.pageX-a.body.offset().left+parseInt(a.body[0].scrollLeft);if(r==a.columns.length-1)i-=80;a.popup.css({left:i,top:a.gridheader.height()+1});a.popup.toggle();return false})},initHeight:function(){if(t.isScroll==false)t.height="auto";if(t.height=="auto"){a.gridbody.height("auto")}if(t.width){$(e).width(t.width);$(e).height(t.height)}l.onResize()},initFootbar:function(){if(t.usePager){var e="";var r=-1;$(t.pageSizeOptions).each(function(a,i){var l="";if(t.pageSize==i)r=a;e+="<option value='"+i+"' "+l+" >"+i+"</option>"});$(".l-bar-selectpagesize",a.toolbar).append("<select name='rp'>"+e+"</select>");if(r!=-1)$(".l-bar-selectpagesize select",a.toolbar)[0].selectedIndex=r;if(t.switchPageSizeApplyComboBox&&$.fn.ligerComboBox){$(".l-bar-selectpagesize select",a.toolbar).ligerComboBox({onBeforeSelect:function(){if(a.isDataChanged&&!confirm(t.isContinueByDataChanged))return false;return true},width:45})}}else{a.toolbar.hide()}},initEven:function(){a.header.click(function(){a.popup.hide();a.endEdit()});$(".l-grid-hd-cell",a.gridheader).hover(function(){},function(){}).mousedown(function(e){if(a.colresize)return false});$(".l-grid-hd-cell-text",a.gridheader).click(function(e){var r=e.target||e.srcElement;var i=$(this).parent().parent();if(!i.attr("columnname"))return;if(a.colresize)return false;if(!t.enabledSort)return;if(i.attr("isSort")!=undefined&&i.attr("isSort").toLowerCase()=="false")return;if(a.isDataChanged&&!confirm(t.isContinueByDataChanged))return false;var l=$(".l-grid-hd-cell-sort",i);var n=$(i).attr("columnname");if(l.length>0){if(l.hasClass("l-grid-hd-cell-sort-asc")){l.removeClass("l-grid-hd-cell-sort-asc").addClass("l-grid-hd-cell-sort-desc");i.removeClass("l-grid-hd-cell-asc").addClass("l-grid-hd-cell-desc");a.changeSort(n,"desc")}else if(l.hasClass("l-grid-hd-cell-sort-desc")){l.removeClass("l-grid-hd-cell-sort-desc").addClass("l-grid-hd-cell-sort-asc");i.removeClass("l-grid-hd-cell-desc").addClass("l-grid-hd-cell-asc");a.changeSort(n,"asc")}}else{i.removeClass("l-grid-hd-cell-desc").addClass("l-grid-hd-cell-asc");$(this).after("<span class='l-grid-hd-cell-sort l-grid-hd-cell-sort-asc'>&nbsp;&nbsp;</span>");a.changeSort(n,"asc")}$(".l-grid-hd-cell-sort",i.siblings()).remove();return false});a.gridheader.click(function(){a.endEdit()});if(t.allowAdjustColWidth){a.gridheader.mousemove(function(t){if(a.colresize)return;var r=t.pageX-$(e).offset().left;var i=0;for(var l=0;l<a.headers.length;l++){if(a.headers[l].width)i+=a.headers[l].width+1;if(a.headers[l].isdetail||a.headers[l].ischeckbox)continue;if(r>=i-2-a.gridbody[0].scrollLeft&&r<=i+2-a.gridbody[0].scrollLeft){$("body").css({cursor:"e-resize"});a.toDragHeaderIndex=l;return}}$("body").css({cursor:"default"});a.toDragHeaderIndex=null}).mouseout(function(e){if(a.colresize)return;$("body").css({cursor:"default"})}).mousedown(function(e){if(a.colresize)return;if(a.toDragHeaderIndex==null)return;l.dragStart("colresize",e,a.toDragHeaderIndex)})}if(t.allowHideColumn){$("tr",a.popup).hover(function(){$(this).addClass("l-popup-row-over")},function(){$(this).removeClass("l-popup-row-over")});var r=function(){if($("input:checked",a.popup).length+1<=t.minColToggle){return false}a.toggleCol(parseInt($(this).attr("columnindex")),this.checked)};if($.fn.ligerCheckBox)$(":checkbox",a.popup).change(r);else $(":checkbox",a.popup).click(r)}a.gridbody.scroll(function(){var e=a.gridbody.scrollLeft();if(e==undefined)return;a.gridheader[0].scrollLeft=e});$(e).click(function(r){var i=r.target||r.srcElement;if(i.tagName.toLowerCase()=="span"&&$(i).hasClass("l-grid-row-cell-detailbtn")){var l=$(i).parent().parent().parent();if(l.parent().parent()[0]!=$("table:first",a.gridbody)[0])return;var n=parseInt($(l).attr("rowindex"));var o=a.currentData[t.root][n];if($(i).hasClass("l-open")){l.next(".l-grid-detailpanel").hide();$(i).removeClass("l-open")}else{var d=l.next(".l-grid-detailpanel");if(d.length>0){d.show();$(i).addClass("l-open");return}var s=$("<tr class='l-grid-detailpanel'><td><div class='l-grid-detailpanel-inner' style='display:none'></div></td></tr>");var u=$("div:first",s);u.width(a.gridtablewidth-1);u.parent().attr("colSpan",a.headers.length).width(a.gridtablewidth-1);l.after(s);if(t.detail.onShowDetail){t.detail.onShowDetail(o,u[0]);u.show()}else if(t.detail.render){u.append(t.detail.render());u.show()}$(i).addClass("l-open")}return}if($(i).hasClass("l-grid-tree-link")){var c=$(i).parent().parent().parent().get(0);a.toggle(c);return}if(i.tagName.toLowerCase()=="div"&&$(i).hasClass("l-grid-hd-cell-btn-checkbox")){var l=$(i).parent().parent().parent();var g=l.hasClass("l-checked");if(t.onBeforeCheckAllRow){if(t.onBeforeCheckAllRow(!g,e)==false)return false}if(g){l.removeClass("l-checked");$("tbody:first > tr.l-grid-row",a.gridbody).removeClass("l-checked")}else{l.addClass("l-checked");$("tbody:first > tr.l-grid-row",a.gridbody).addClass("l-checked")}t.onCheckAllRow&&t.onCheckAllRow(!g,e)}});$(e).dblclick(function(e){var r=e.target||e.srcElement;var i;var n=$(r).parent()[0].tagName.toLowerCase();if(n=="div"){i=$(r).parent()}else if(n=="span"){i=$(r).parent().parent()}if(r.tagName.toLowerCase()=="span"&&(i.hasClass("l-grid-row-cell-inner")||i.hasClass("l-grid-row-cell-inner-fixedheight"))){if(t.enabledEdit&&!t.dblClickToEdit){var o=null;if(i.hasClass("l-grid-row-cell"))o=i.parent();else o=i.parent().parent();if(t.allowUnSelectRow||o.hasClass("l-selected-again"))l.applyEditor(i)}else{if(t.dblClickRow){return t.dblClickRow({data:a.getClickRow(r)},e)}}}else{if(t.dblClickRow){return t.dblClickRow({data:a.getClickRow(r)},e)}}});$("select",a.toolbar).change(function(){if(a.isDataChanged&&!confirm(t.isContinueByDataChanged))return false;t.newPage=1;t.pageSize=this.value;a.loadData(t.where)});$(".pcontrol input",a.toolbar).keydown(function(e){if(e.keyCode==13)a.changePage("input")});$(".l-bar-button",a.toolbar).hover(function(){$(this).addClass("l-bar-button-over")},function(){$(this).removeClass("l-bar-button-over")}).click(function(){if($(this).hasClass("l-bar-btnfirst")){if(t.onToFirst&&t.onToFirst(e)==false)return false;a.changePage("first")}else if($(this).hasClass("l-bar-btnprev")){if(t.onToPrev&&t.onToPrev(e)==false)return false;a.changePage("prev")}else if($(this).hasClass("l-bar-btnnext")){if(t.onToNext&&t.onToNext(e)==false)return false;a.changePage("next")}else if($(this).hasClass("l-bar-btnlast")){if(t.onToLast&&t.onToLast(e)==false)return false;a.changePage("last")}else if($(this).hasClass("l-bar-btnload")){if($("span",this).hasClass("l-disabled"))return false;if(t.onReload&&t.onReload(e)==false)return false;if(a.isDataChanged&&!confirm(t.isContinueByDataChanged))return false;a.loadData(t.where)}});$("#curPage").bind("blur",function(){var e=$(this);if(!/^[1-9]\d*$/.test(e.val())){top.dialog.warn("请输入正整数!","警告",function(){e.value="";e.focus()})}else{a.changePage("input")}});a.toolbar.click(function(){a.popup.hide();a.endEdit()});$(document).mousemove(function(e){l.dragMove(e)}).mouseup(function(e){l.dragEnd(e)}).hover(function(){},function(e){l.dragEnd(e)}).click(function(e){l.onClick(e)});$(window).resize(l.onResize)},searchData:function(e,t){var r=new Array;for(var a=0;a<e.length;a++){if(t(e[a],a)){r[r.length]=e[a]}}return r},showData:function(r){$(".l-bar-btnloading:first",a.toolbar).removeClass("l-bar-btnloading");if(!r||!r[t.root])return;if(t.onBeforeShowData&&t.onBeforeShowData(e,r)==false){return false}a.isDataChanged=false;$(".l-bar-btnload:first span",a.toolbar).removeClass("l-disabled");a.loading=false;if(t.usePager){t.total=r[t.record];t.page=t.newPage;t.pageCount=Math.ceil(t.total/t.pageSize);l.buildPager()}a.gridbody.html("");var i=['<div class="l-grid-body-inner"><table class="l-grid-body-table" cellpadding=0 cellspacing=0><tbody>'];if(t.groupColumnName){var n=[];var o=[];$(r[t.root]).each(function(e,r){var a=r[t.groupColumnName];var i=$.inArray(a,n);if(i==-1){n.push(a);i=n.length-1;o.push([])}o[i].push(r)});$(o).each(function(e,r){i.push('<tr class="l-grid-grouprow" rowcount="'+r.length+'">');
i.push('<td colSpan="'+a.headers.length+'" class="l-grid-grouprow-cell">');i.push('<span class="l-grid-group-togglebtn">&nbsp;&nbsp;&nbsp;&nbsp;</span>');i.push(t.groupColumnDisplay+":"+n[e]);i.push("</td>");i.push("</tr>");i.push(l.getHtmlFromData(r));if(a.isTotalSummary())i.push(l.getTotalSummaryHtml(r,"l-grid-totalsummary-group"))})}else if(t.tree){if(!t.tree.columnName)t.tree.columnName="name";if(!t.tree.childrenName)t.tree.childrenName="children";if(!t.tree.isParent)t.tree.isParent=function(e){var t="children"in e&&e.children!="";return t};if(!t.tree.isExtend)t.tree.isExtend=function(e){if("isextend"in e&&e["isextend"]==false)return false;return true};i.push(l.getHtmlFromData(r[t.root],t.tree,1))}else{i.push(l.getHtmlFromData(r[t.root]))}i.push("</tbody></table></div>");a.gridbody.html(i.join(""));if(!t.groupColumnName){l.bulidTotalSummary()}$("> div:first",a.gridbody).width(a.gridtablewidth);l.onResize();$("tbody:first > .l-grid-grouprow",a.gridbody).each(function(){var e=$(this);$(".l-grid-group-togglebtn",e).click(function(){var t=true;if($(this).hasClass("l-grid-group-togglebtn-close"))$(this).removeClass("l-grid-group-togglebtn-close");else{t=false;$(this).addClass("l-grid-group-togglebtn-close")}var r=e.next(".l-grid-row,.l-grid-totalsummary-group");while(true){if(r.length==0)break;if(t)r.show();else r.hide();r=r.next(".l-grid-row,.l-grid-totalsummary-group")}})});$("tbody:first > .l-grid-row",a.gridbody).each(function(){l.setRowEven(this)});if(t.totalRender){$(".l-panel-bar-total",e).remove();$(".l-panel-bar",e).before('<div class="l-panel-bar-total">'+t.totalRender(a.data,a.filteredData)+"</div>")}if(t.onAfterShowData){t.onAfterShowData(e,r,a)}},onClick:function(e){var r=e.target||e.srcElement;var i=r.tagName.toLowerCase();if(a.grideditor.editingCell){if(i=="html"||i=="body"||$(r).hasClass("l-grid-body")||$(r).hasClass("l-grid-row")){a.endEdit(true)}}if(t.allowHideColumn){if(i=="html"||i=="body"||$(r).hasClass("l-grid-body")||$(r).hasClass("l-grid-row")||$(r).hasClass("l-grid-row-cell-inner")||$(r).hasClass("l-grid-header")){a.popup.hide()}}},replaceHtmlTag:function(e){return e.replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/\"/g,"&quot;")},getHtmlFromData:function(e,r,i,n){var o=1;if(!e||!e.length)return"";var d=[];var s=e.length;$(e).each(function(e,u){if(!u)return;if(!t.usePager&&e==s-1&&!a.isTotalSummary())d.push('<tr class="l-grid-row l-grid-row-last');else d.push('<tr class="l-grid-row');if(r){d.push(" l-grid-treerow")}if(t.checkbox&&t.isChecked&&t.isChecked(u)){d.push(" l-checked")}if(e%2==1&&t.alternatingRow)d.push(" l-grid-row-alt");d.push('" ');if(r)d.push(" treelevel= "+i);if(t.rowAttrRender)d.push(t.rowAttrRender(u,e));var c=a.recordNumber;d.push(" rowid= "+c);a.records[a.recordNumber]=u;a.recordNumber++;if(n!=undefined)d.push(" parentrowid= "+n);d.push(' rowindex="'+e+'">');$(a.headers).each(function(n,s){if(this.ischeckbox){d.push('<td class="l-grid-row-cell l-grid-row-cell-checkbox" style="width:'+this.width+'px"><div class="l-grid-row-cell-inner"><span class="l-grid-row-cell-btn-checkbox"></span></div></td>');return}else if(this.isdetail){d.push('<td class="l-grid-row-cell l-grid-row-cell-detail" style="width:'+this.width+'px"><div class="l-grid-row-cell-inner"><span class="l-grid-row-cell-detailbtn"></span></div></td>');return}var c=a.columns[this.columnindex];var g=this.width;if(!this.islast)d.push('<td class="l-grid-row-cell" columnindex="'+this.columnindex+'" ');else d.push('<td class="l-grid-row-cell l-grid-row-cell-last" columnindex="'+this.columnindex+'" ');if(this.columnname)d.push('columnname="'+this.columnname+'"');d.push(' style = "');if(typeof g=="string"&&g.indexOf("%")>0){d.push("width:"+g+'" ')}else{d.push("width:"+g+'px" ')}if(t.fixedCellHeight)d.push('><div class="l-grid-row-cell-inner l-grid-row-cell-inner-fixedheight" ');else d.push('><div class="l-grid-row-cell-inner" ');if(typeof g=="string"&&g.indexOf("%")>0){d.push(' style = "width:95%; ')}else{d.push(' style = "width:'+parseInt(g-8)+"px; ")}if(c&&c.align)d.push("text-align:"+c.align+";");if(c&&c.type&&c.type=="date"){var f=t.renderDate(u[this.columnname]);u[this.columnname]=f}var h=this.columnname;var p=u;var v;if(h.indexOf(".")>0){while(h.indexOf(".")>0){v=h.substr(0,h.indexOf("."));h=h.substr(h.indexOf(".")+1);if(p[v]&&h.indexOf(".")==-1){p=p[v][h]}else p=p[v]}}else{p=p[this.columnname]}var m="";if(c.initDataFunc){m=c.initDataFunc(p,u)}else{m=l.getCellContent(u,e,p,c,r,i)}if(c&&c.dataCategory&&c.dataCategory=="switch"){var b=easyloader.URI;if(m==1){m="<img src='"+b+"/skins/default/images/btn_qiyong.gif' />"}else if(m==0){m="<img src='"+b+"/skins/default/images/btn_jinyong.gif' / >"}}if(c&&c.dataCategory&&c.dataCategory=="date"){if(m!=""){var f=new Date;f.setTime(m);var w=c.format?c.format:t.dateFormat;m=a.getFormatDate(f,w)}}if(c&&c.dataCategory&&c.dataCategory=="defaultValue"){if(m==""){m=c.defaultValue}}if(c&&c.dataCategory&&c.dataCategory=="index"){m=o++}if(c&&c.dataCategory&&c.dataCategory=="fileSize"){var C=m*1;if(C<1024){m=C+"b"}else if(C>=1024&&C<1024*1024){m=l.toDecimal(C/1024)+"k"}else if(C>=1024*1024&&C<1024*1024*1024){m=l.toDecimal(C/(1024*1024))+"M"}else if(C>=1024*1024*1024&&C<1024*1024*1024*1024){m=l.toDecimal(C/(1024*1024*1024))+"G"}else if(C>=1024*1024*1024*1024&&C<1024*1024*1024*1024*1024){m=l.toDecimal(C/(1024*1024*1024*1024))+"T"}}if(c&&c.dataCategory&&c.dataCategory=="fileOperate"){var $=p;m="<span><a class='small_button' href='"+easyloader.URI+"/attach/"+$[0]+$[1]+"' target='_blank'>查看</a></span>"}if(!(r&&r.isParent(u))){m="<span>"+m+"</span>"}d.push('">'+m+"</div></td>")});d.push("</tr>");if(r&&r.isParent(u)){var g=u[r.childrenName];if(g)d.push(l.getHtmlFromData(g,r,i+1,c))}});return d.join("")},toDecimal:function(e){var t=parseFloat(e);if(isNaN(t)){return}t=Math.round(e*100)/100;return t},getTreeCellHtml:function(e,t,r,a){var i=e.isExtend(r);var l=e.isParent(r);var n="";for(var o=1;o<a;o++){n+="<div class='l-grid-tree-space'></div>"}if(i&&l)n+="<div class='l-grid-tree-space l-grid-tree-link l-grid-tree-link-open'></div>";else if(l)n+="<div class='l-grid-tree-space l-grid-tree-link l-grid-tree-link-close'></div>";else n+="<div class='l-grid-tree-space'></div><span class='l-grid-sub-arrow'><img src='"+easyloader.URI+"/skins/default/images/icon_arrow.gif'>&nbsp;</span>";n+="<span class='l-grid-tree-content'>"+t+"</span>";return n},getCellContent:function(e,r,i,n,o,d){var s="";if(n.render){s=n.render(e,r,i,n)}else if(n.type=="date"){s=i.toString();if(i instanceof Date){if(n.format)s=a.getFormatDate(i,n.format);else s=a.getFormatDate(i,t.dateFormat)}}else{if(i==null)i="";s=i.toString()}if(o&&o.columnName==n.name){s=l.getTreeCellHtml(o,s,e,d)}if(!s)s="";return s},setRowEven:function(e){$(e).bind("contextmenu",function(e){var r=e.target||e.srcElement;if(t.onRClickToSelect)if(!$(this).hasClass("l-checked")){$(this).addClass("l-checked").siblings(".l-checked").removeClass("l-checked")}if(t.onContextmenu){var i=$(this).attr("rowid");var l=$(this).attr("rowindex");var n=a.getRow(i);return t.onContextmenu({data:n,rowindex:l,row:this},e)}});$(e).hover(function(e){if(!t.mouseoverRowCssClass)$(this).addClass(t.mouseoverRowCssClass)},function(e){if(!t.mouseoverRowCssClass)$(this).removeClass(t.mouseoverRowCssClass)}).click(function(e){if(t.checkbox){var r=e.target||e.srcElement;var i=t.selectRowButtonOnly?true:false;if(t.enabledEdit)i=true;if(!($(r).hasClass("l-grid-tree-link-close")||$(r).hasClass("l-grid-tree-link-open"))&&!i||$(r).hasClass("l-grid-row-cell-btn-checkbox")){var l=$(this);var n=l.attr("rowindex");var o=l.attr("rowid");var d=l.hasClass("l-checked");if(t.onBeforeCheckRow){if(t.onBeforeCheckRow(!d,a.getRow(o),n,l[0])==false)return false}if(e.ctrlKey||$(r).hasClass("l-grid-row-cell-btn-checkbox")){if(d){l.removeClass("l-checked");$("tbody :first").removeClass("l-checked")}else l.addClass("l-checked")}else{if(d&&$(".l-checked",l.parent()).size()==1)l.removeClass("l-checked");else{l.addClass("l-checked").siblings().removeClass("l-checked");$("tbody :first").removeClass("l-checked")}}t.onCheckRow&&t.onCheckRow(!d,a.getRow(o),n,l[0])}if(!t.enabledEdit)return}var n=$(this).attr("rowindex");var o=$(this).attr("rowid");if($(this).hasClass("l-selected")){if(!t.allowUnSelectRow){$(this).addClass("l-selected-again");return}$(this).removeClass("l-selected l-selected-again");if(t.onUnSelectRow){t.onUnSelectRow(a.getRow(o),n,this)}}else{$(this).siblings(".l-selected").each(function(){if(t.allowUnSelectRow||$(this).hasClass("l-selected-again"))a.endEdit();$(this).removeClass("l-selected l-selected-again")});$(this).addClass("l-selected");if(t.onSelectRow){t.onSelectRow(a.getRow(o),n,this)}}}).dblclick(function(e){var r=e.target||e.srcElement;var i=$(this).attr("rowindex");var l=$(this).attr("rowid");var n=$(this);if(!($(r).hasClass("l-grid-tree-link-close")||$(r).hasClass("l-grid-tree-link-open"))){n.addClass("l-checked").siblings().removeClass("l-checked")}if(t.onDblClickRow){t.onDblClickRow(a.getRow(l),i,this)}})},applyEditor:function(r){if(r.href||r.type)return true;var i;if($(r).hasClass("l-grid-row-cell"))i=r;else if($(r).parent().hasClass("l-grid-row-cell"))i=$(r).parent()[0];if(!i)return;var n=$(i).parent();var o=n.attr("rowindex");var d=n.attr("rowid");var s=$(i).attr("columnindex");var u=$(i).attr("columnname");var c=a.columns[s];if(!c)return;var g=$(i).offset().left-a.body.offset().left;var f=$(i).offset().top-$(e).offset().top;var h=a.getRow(d);var p=h[u];var v={record:h,value:p,column:c,columnname:u,columnindex:s,rowindex:o,rowObj:n[0],cellObj:i};if(t.onBeforeEdit){if(!t.onBeforeEdit(v))return false}a.grideditor.css({left:g,top:f,width:$(i).css("width"),height:$(i).css("height")}).html("");a.grideditor.editingCell=null;if(c.editor&&c.editor.type=="date"){if(""==p||null==p||isNaN(p)){p=new Date}else{p=a.stringToDate(p)}var m=$("<input type='text'/>");a.grideditor.append(m);m.val(a.getFormatDate(p,t.dateFormat));var b={width:$(i).width(),onChangeDate:function(e){$(i).addClass("l-grid-row-cell-edited");if(c.editor.onChange)c.editor.onChange(i,e);v.value=e;if(l.checkEditAndUpdateCell(v)){if(c.editor.onChanged)c.editor.onChanged(i,e)}}};if(c.editor.p)b=$.expend({},typeof c.editor.p=="function"?c.editor.p(h,o,p,c):c.editor.p,b);m.ligerDateEditor(b);a.grideditor.editingCell=i;a.grideditor.show()}else if(c.editor&&c.editor.type=="select"){var m=$("<input type='text'/>");a.grideditor.append(m);var b={width:$(i).width(),onSelected:function(e,t){$(i).addClass("l-grid-row-cell-edited");if(c.editor.valueColumnName)h[c.editor.valueColumnName]=e;if(c.editor.displayColumnName)h[c.editor.displayColumnName]=t;if(c.editor.onChange)c.editor.onChange(i,e);v.value=e;if(l.checkEditAndUpdateCell(v)){if(c.editor.onChanged)c.editor.onChanged(i,e)}}};if(c.editor.data)b.data=c.editor.data;if(c.editor.dataValueField)b.valueField=c.editor.dataValueField;else if(c.editor.valueColumnName)b.valueField=c.editor.valueColumnName;if(c.editor.dataDisplayField)b.displayField=b.textField=c.editor.dataDisplayField;else if(c.editor.displayColumnName)b.displayField=b.textField=c.editor.displayColumnName;if(c.editor.valueColumnName)b.initValue=a.currentData[t.root][o][c.editor.valueColumnName];else if(c.editor.dataDisplayField)b.initText=a.currentData[t.root][o][c.editor.dataDisplayField];if(c.editor.p){var w=typeof c.editor.p=="function"?c.editor.p(h,o,p,c):c.editor.p;b=$.extend({},b,w)}m.ligerComboBox(b);a.grideditor.editingCell=i;a.grideditor.show()}else if(c.editor&&(c.editor.type=="int"||c.editor.type=="float"||c.editor.type=="spinner")){var m=$("<input type='text'/>");a.grideditor.append(m);m.attr({style:"border:#6E90BE"}).val(p);var b={width:$(i).width(),height:$(i).height(),type:c.editor.type=="float"?"float":"int",onChangeValue:function(e){$(i).addClass("l-grid-row-cell-edited");if(c.editor.onChange)c.editor.onChange(i,e);v.value=e;if(l.checkEditAndUpdateCell(v)){if(c.editor.onChanged)c.editor.onChanged(i,e)}}};if(c.editor.minValue!=undefined)b.minValue=c.editor.minValue;if(c.editor.maxValue!=undefined)b.maxValue=c.editor.maxValue;m.ligerSpinner(b);a.grideditor.editingCell=i;a.grideditor.show()}else if(c.editor&&(c.editor.type=="string"||c.editor.type=="text")){var m=$("<input type='text' class='l-text-editing'/>");a.grideditor.append(m);m.val(p);m.ligerTextBox({width:$(i).width()-1,height:$(i).height(),onChangeValue:function(e){$(i).addClass("l-grid-row-cell-edited");if(c.editor.onChange)c.editor.onChange(i,e);v.value=e;m.val(e);if(l.checkEditAndUpdateCell(v)){if(c.editor.onChanged)c.editor.onChanged(i,e)}}}).bind("keydown",function(e){var t=e.which;if(t==13){m.trigger("change");a.endEdit()}});m.parent().addClass("l-text-editing");a.grideditor.editingCell=i;a.grideditor.show()}else if(c.editor&&(c.editor.type=="chk"||c.editor.type=="checkbox")){var C=$("<input type='checkbox'/>");a.grideditor.append(C);C[0].checked=p==1?true:false;C.ligerCheckBox();C.change(function(){if(c.editor.onChange)c.editor.onChange(i,this.checked);v.value=this.checked?1:0;if(l.checkEditAndUpdateCell(v)){if(c.editor.onChanged)c.editor.onChanged(i,this.checked)}});a.grideditor.editingCell=i;a.grideditor.show()}},checkEditAndUpdateCell:function(e){if(t.onBeforeSubmitEdit){if(!t.onBeforeSubmitEdit(e))return false}a.grideditor.editingValue=e.value;a.updateCell(e.cellObj,e.value);return true},getCurrentPageData:function(e){var r=$.extend({},e);r[t.root]=new Array;if(!e||!e[t.root]||!e[t.root].length){r[t.record]=0;return r}r[t.record]=e[t.root].length?e[t.root].length:0;if(!t.newPage)t.newPage=1;for(i=(t.newPage-1)*t.pageSize;i<e[t.root].length&&i<t.newPage*t.pageSize;i++){var a=$.extend({},e[t.root][i]);r[t.root].push(a)}return r},compareData:function(e,t,r,a){if(e[r]==null&&t[r]!=null)return 1;else if(e[r]==null&&t[r]==null)return 0;else if(e[r]!=null&&t[r]==null)return-1;switch(a){case"int":return parseInt(e[r])<parseInt(t[r])?-1:parseInt(e[r])>parseInt(t[r])?1:0;case"float":return parseFloat(e[r])<parseFloat(t[r])?-1:parseFloat(e[r])>parseFloat(t[r])?1:0;case"string":return e[r].localeCompare(t[r]);case"date":return e[r]<t[r]?-1:e[r]>t[r]?1:0}return e[r].localeCompare(t[r])},getTotalSummaryHtml:function(e,t){var r=[];if(t)r.push('<tr class="l-grid-totalsummary '+t+'">');else r.push('<tr class="l-grid-totalsummary">');$(a.headers).each(function(){r.push('<td class="l-grid-totalsummary-cell');if(this.islast)r.push(" l-grid-totalsummary-cell-last");r.push('" ');r.push('width="'+this.width+'" ');columnname=this.columnname;columnindex=this.columnindex;if(columnname){r.push('columnname="'+columnname+'" ')}r.push('columnindex="'+columnindex+'" ');r.push('><div class="l-grid-totalsummary-cell-inner"');var t=a.columns[columnindex];if(t.align)r.push(' textAlign="'+t.align+'"');r.push(">");if(t.totalSummary){var i=function(e){for(var t=0;t<f.length;t++)if(f[t].toLowerCase()==e.toLowerCase())return true;return false};var l=0,n=0,o=0;var d=parseFloat(e[0][t.name]);var s=parseFloat(e[0][t.name]);for(var u=0;u<e.length;u++){var c=parseFloat(e[u][t.name]);if(!c)continue;l+=c;n+=1;if(c>d)d=c;if(c<s)s=c}o=l*1/e.length;if(t.totalSummary.render){var g=t.totalSummary.render({sum:l,count:n,avg:o,min:s,max:d},t,a.data);r.push(g)}else if(t.totalSummary.type){var f=t.totalSummary.type.split(",");if(i("sum"))r.push("<div>Sum="+l.toFixed(2)+"</div>");if(i("count"))r.push("<div>Count="+n+"</div>");if(i("max"))r.push("<div>Max="+d.toFixed(2)+"</div>");if(i("min"))r.push("<div>Min="+s.toFixed(2)+"</div>");if(i("avg"))r.push("<div>Avg="+o.toFixed(2)+"</div>")}r.push("</div></td>")}});r.push("</tr>");return r.join("")},bulidTotalSummary:function(){if(!a.isTotalSummary())return false;if(!a.currentData||a.currentData[t.root].length==0)return false;$("tbody:first",a.gridbody).append(l.getTotalSummaryHtml(a.currentData[t.root]))},buildPager:function(){$(".pcontrol input",a.toolbar).val(t.page);$(".pcontrol span",a.toolbar).html(t.pageCount==0?1:t.pageCount);var e=parseInt((t.page-1)*t.pageSize)+1;var r=parseInt(e)+parseInt(t.pageSize)-1;if(t.total<r)r=t.total;var i=t.pageStatMessage;i=i.replace(/{from}/,e==1&&r==0?0:e);i=i.replace(/{to}/,r);i=i.replace(/{total}/,t.total);i=i.replace(/{pagesize}/,t.pageSize);$(".l-bar-text",a.toolbar).html(i);if(!t.total){$(".l-bar-btnfirst span,.l-bar-btnprev span,.l-bar-btnnext span,.l-bar-btnlast span",a.toolbar).addClass("l-disabled")}if(t.page==1){$(".l-bar-btnfirst span",a.toolbar).addClass("l-disabled");$(".l-bar-btnprev span",a.toolbar).addClass("l-disabled")}else if(t.page>t.pageCount&&t.pageCount>0){$(".l-bar-btnfirst span",a.toolbar).removeClass("l-disabled");$(".l-bar-btnprev span",a.toolbar).removeClass("l-disabled")}if(t.page==t.pageCount){$(".l-bar-btnlast span",a.toolbar).addClass("l-disabled");$(".l-bar-btnnext span",a.toolbar).addClass("l-disabled")}else if(t.page<t.pageCount&&t.pageCount>0){$(".l-bar-btnlast span",a.toolbar).removeClass("l-disabled");$(".l-bar-btnnext span",a.toolbar).removeClass("l-disabled")}},onResize:function(){if(t.height&&t.height!="auto"){var r=$(window).height();var i=0;var n=null;if(typeof t.height=="string"&&t.height.indexOf("%")>0){var o=$(e).parent();if(t.InWindow||o[0].tagName.toLowerCase()=="body"){n=r;n-=parseInt($("body").css("paddingTop"));n-=parseInt($("body").css("paddingBottom"))}else{n=o.height()}i=n*parseFloat(t.height)*.01;if(t.InWindow||o[0].tagName.toLowerCase()=="body")i-=$(e).offset().top-parseInt($("body").css("paddingTop"))}else{i=parseInt(t.height)}i+=t.heightDiff;a.windowHeight=r;l.setHeight(i)}},setHeight:function(e){if(t.title)e-=24;if(t.usePager)e-=32;if(t.totalRender)e-=25;e-=23*(a.getMulHeaderLevel()-1);e-=22;e>0&&a.gridbody.height(e)},dragStart:function(t,r,i){if(t=="colresize"){var l=a.headers[a.toDragHeaderIndex].columnindex;var n=a.headers[a.toDragHeaderIndex].width;if(l==undefined)return;a.colresize={startX:r.pageX,width:n,columnindex:l};$("body").css("cursor","e-resize");a.draggingline.css({height:a.body.height(),left:r.pageX-$(e).offset().left+parseInt(a.body[0].scrollLeft),top:0}).show();$("body").bind("selectstart",function(){return false})}$.fn.ligerNoSelect&&$("body").ligerNoSelect()},dragMove:function(t){if(a.colresize){var r=t.pageX-a.colresize.startX;var i=a.colresize.width+r;a.colresize.newwidth=i;$("body").css("cursor","e-resize");a.draggingline.css({left:t.pageX-$(e).offset().left+parseInt(a.body[0].scrollLeft)});$("body").unbind("selectstart")}},dragEnd:function(e){if(a.colresize){if(a.colresize.newwidth==undefined){$("body").css("cursor","default");return false}var t=80;var r=a.colresize.columnindex;var i=a.columns[r];if(i&&i.minWidth)t=i.minWidth;var n=a.colresize.newwidth;n=n<t?t:n;var o=n-a.colresize.width;a.headers[a.toDragHeaderIndex].width+=o;a.gridtablewidth+=o;$("div:first",a.gridheader).width(a.gridtablewidth+40);$("div:first",a.gridbody).width(a.gridtablewidth);$(".l-grid-hd-cell[columnindex="+r+"]",a.gridheader).css("width",n);$("tbody:first > .l-grid-row > td[columnindex="+r+"],tbody:first > .l-grid-totalsummary > td[columnindex="+r+"]",a.gridbody).each(function(){$(this).css("width",n);$("div:first",this).css("width",n-8)});l.onResize();a.draggingline.hide();a.colresize=false}$("body").css("cursor","default");$.fn.ligerNoSelect&&$("body").ligerNoSelect(false)}};a.header=$(".l-panel-header:first",e);a.body=$(".l-panel-body:first",e);a.toolbar=$(".l-panel-bar:first",e);a.popup=$(".l-grid-popup:first",e);a.grideditor=$(".l-grid-editor:first",e);a.gridloading=$(".l-grid-loading:first",e);a.draggingline=$(".l-grid-dragging-line",e);a.gridheader=$(".l-grid-header:first",e);a.gridbody=$(".l-grid-body:first",e);a.currentData=null;a.recordNumber=0;a.records={};l.init();if(e.id==undefined)e.id="LigerUI_"+(new Date).getTime();LigerUIManagers[e.id+"_Grid"]=a;e.usedGrid=true};$.ligerGridSetParms=function(e,t){e=$.extend({},$.ligerDefaults.Grid,$.ligerDefaults.GridString,e||{});if(e.url&&e.data){e.dataType="local"}else if(e.url&&!e.data){e.dataType="server"}else if(!e.url&&e.data){e.dataType="local"}else if(!e.url&&!e.data){e.dataType="local";e.data=[]}if(e.dataType=="local")e.dataAction="local";if(t){e=$.extend(e,t)}return e};$.fn.ligerGrid=function(e){var t={};e=e||{};e=$.ligerGridSetParms(e,t);this.each(function(){$.ligerAddGrid(this,e)});if(this.length==0)return null;if(this.length==1)return $(this[0]).ligerGetGridManager();var r=[];this.each(function(){r.push($(this).ligerGetGridManager())});return r};$.getGridData=function(e,t){var r=$("#"+e).ligerGetGridManager();var a=t?r.getSelectedRow():r.getData();if(t&&!a)return"请选择行！";return JSON.stringify(a)};$.getCheckedGridData=function(e){var t=$("#"+e).ligerGetGridManager();if(!t)return;var r=t.getCheckedRows();return JSON.stringify(r)};$.saveGridData=function(gridId,url,execFunc){var manager=$("#"+gridId).ligerGetGridManager();var data=manager.getData();$.ajax({type:"post",url:url?url:"",data:{grid_data:JSON.stringify(data)},success:function(ret){var returnValue=eval("("+$.trim(ret)+")");var gdata;if(returnValue.status==1){if(execFunc&&typeof execFunc=="function")execFunc($.trim(ret));else{try{gdata=eval("("+returnValue.gdata+")");top.gdata=gdata}catch(e){}$.ligerDialog.alert(returnValue.msg,"提示","success",function(){manager.loadData(true)})}}else{$.ligerDialog.error("异常！")}},error:function(e,t){$.ligerDialog.error(stauts)}})};$.deleteSeletedData=function(gridId,url,execFunc){var manager=$("#"+gridId).ligerGetGridManager();if(!manager)return;var checkedData=manager.getCheckedRows();var ids=[];if(checkedData==null||checkedData.length==0){checkedData=manager.getSelectedRow();if(checkedData!=null)ids.push(checkedData.pkId)}else{for(var i=0;i<checkedData.length;i++)ids.push(checkedData[i].pkId)}if(ids==""){top.$.ligerDialog.alert("请选择要删除的行！","提示","warn");return}top.$.ligerDialog.confirm("确定要删除选定的行吗？",function(r){if(r){$.ajax({type:"post",url:url?url:"",data:"ids="+ids,success:function(ret){var returnValue=eval("("+$.trim(ret)+")");if(execFunc&&typeof execFunc=="function")execFunc($.trim(ret));else if(returnValue.status==1){manager.deleteSelectedRow()}}})}})}})(jQuery);