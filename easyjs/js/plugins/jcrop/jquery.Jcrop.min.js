(function(e){e.Jcrop=function(t,i){var n=e.extend({},e.Jcrop.defaults),r,a=navigator.userAgent.toLowerCase(),o=/msie/.test(a),s=/msie [1-6]\./.test(a);function c(e){return Math.round(e)+"px"}function u(e){return n.baseClass+"-"+e}function f(){return e.fx.step.hasOwnProperty("backgroundColor")}function l(t){var i=e(t).offset();return[i.left,i.top]}function d(e){return[e.pageX-r[0],e.pageY-r[1]]}function h(t){if(typeof t!=="object")t={};n=e.extend(n,t);e.each(["onChange","onSelect","onRelease","onDblClick"],function(e,t){if(typeof n[t]!=="function")n[t]=function(){}})}function p(e,t,i){r=l(F);tt.setCursor(e==="move"?e:e+"-resize");if(e==="move"){return tt.activateHandlers(b(t),x,i)}var n=$.getFixed();var a=v(e);var o=$.getCorner(v(a));$.setPressed($.getCorner(a));$.setCurrent(o);tt.activateHandlers(g(e,n),x,i)}function g(e,t){return function(i){if(!n.aspectRatio){switch(e){case"e":i[1]=t.y2;break;case"w":i[1]=t.y2;break;case"n":i[0]=t.x2;break;case"s":i[0]=t.x2;break}}else{switch(e){case"e":i[1]=t.y+1;break;case"w":i[1]=t.y+1;break;case"n":i[0]=t.x+1;break;case"s":i[0]=t.x+1;break}}$.setCurrent(i);et.update()}}function b(e){var t=e;it.watchKeys();return function(e){$.moveOffset([e[0]-t[0],e[1]-t[1]]);t=e;et.update()}}function v(e){switch(e){case"n":return"sw";case"s":return"nw";case"e":return"nw";case"w":return"ne";case"ne":return"sw";case"nw":return"se";case"se":return"nw";case"sw":return"ne"}}function w(e){return function(t){if(n.disabled){return false}if(e==="move"&&!n.allowMove){return false}r=l(F);V=true;p(e,d(t));t.stopPropagation();t.preventDefault();return false}}function y(e,t,i){var n=e.width(),r=e.height();if(n>t&&t>0){n=t;r=t/e.width()*e.height()}if(r>i&&i>0){r=i;n=i/e.height()*e.width()}X=e.width()/n;G=e.height()/r;e.width(n).height(r)}function m(e){return{x:e.x*X,y:e.y*G,x2:e.x2*X,y2:e.y2*G,w:e.w*X,h:e.h*G}}function x(e){var t=$.getFixed();if(t.w>n.minSelect[0]&&t.h>n.minSelect[1]){et.enableHandles();et.done()}else{et.release()}tt.setCursor(n.allowSelect?"crosshair":"default")}function C(e){if(n.disabled){return false}if(!n.allowSelect){return false}V=true;r=l(F);et.disableHandles();tt.setCursor("crosshair");var t=d(e);$.setPressed(t);et.update();tt.activateHandlers(S,x,e.type.substring(0,5)==="touch");it.watchKeys();e.stopPropagation();e.preventDefault();return false}function S(e){$.setCurrent(e);et.update()}function k(){var t=e("<div></div>").addClass(u("tracker"));if(o){t.css({opacity:0,backgroundColor:"white"})}return t}if(typeof t!=="object"){t=e(t)[0]}if(typeof i!=="object"){i={}}h(i);var z={border:"none",visibility:"visible",margin:0,padding:0,position:"absolute",top:0,left:0};var M=e(t),O=true;if(t.tagName=="IMG"){if(M[0].width!=0&&M[0].height!=0){M.width(M[0].width);M.height(M[0].height)}else{var j=new Image;j.src=M[0].src;M.width(j.width);M.height(j.height)}var F=M.clone().removeAttr("id").css(z).show();F.width(M.width());F.height(M.height());M.after(F).hide()}else{F=M.css(z).show();O=false;if(n.shade===null){n.shade=true}}y(F,n.boxWidth,n.boxHeight);var H=F.width(),D=F.height(),I=e("<div />").width(H).height(D).addClass(u("holder")).css({position:"relative",backgroundColor:n.bgColor}).insertAfter(M).append(F);if(n.addClass){I.addClass(n.addClass)}var B=e("<div />"),P=e("<div />").width("100%").height("100%").css({zIndex:310,position:"absolute",overflow:"hidden"}),J=e("<div />").width("100%").height("100%").css("zIndex",320),A=e("<div />").css({position:"absolute",zIndex:600}).dblclick(function(){var e=$.getFixed();n.onDblClick.call(vt,e)}).insertBefore(F).append(P,J);if(O){B=e("<img />").attr("src",F.attr("src")).css(z).width(H).height(D),P.append(B)}if(s){A.css({overflowY:"hidden"})}var R=n.boundary;var T=k().width(H+R*2).height(D+R*2).css({position:"absolute",top:c(-R),left:c(-R),zIndex:290}).mousedown(C);var K=n.bgColor,E=n.bgOpacity,W,Y,q,L,X,G,N=true,V,Q,U;r=l(F);var Z=function(){function e(){var e={},t=["touchstart","touchmove","touchend"],i=document.createElement("div"),n;try{for(n=0;n<t.length;n++){var r=t[n];r="on"+r;var a=r in i;if(!a){i.setAttribute(r,"return;");a=typeof i[r]=="function"}e[t[n]]=a}return e.touchstart&&e.touchend&&e.touchmove}catch(o){return false}}function t(){if(n.touchSupport===true||n.touchSupport===false)return n.touchSupport;else return e()}return{createDragger:function(e){return function(t){if(n.disabled){return false}if(e==="move"&&!n.allowMove){return false}r=l(F);V=true;p(e,d(Z.cfilter(t)),true);t.stopPropagation();t.preventDefault();return false}},newSelection:function(e){return C(Z.cfilter(e))},cfilter:function(e){e.pageX=e.originalEvent.changedTouches[0].pageX;e.pageY=e.originalEvent.changedTouches[0].pageY;return e},isSupported:e,support:t()}}();var $=function(){var e=0,t=0,i=0,r=0,a,o;function s(n){n=h(n);i=e=n[0];r=t=n[1]}function c(e){e=h(e);a=e[0]-i;o=e[1]-r;i=e[0];r=e[1]}function u(){return[a,o]}function f(n){var a=n[0],o=n[1];if(0>e+a){a-=a+e}if(0>t+o){o-=o+t}if(D<r+o){o+=D-(r+o)}if(H<i+a){a+=H-(i+a)}e+=a;i+=a;t+=o;r+=o}function l(e){var t=d();switch(e){case"ne":return[t.x2,t.y];case"nw":return[t.x,t.y];case"se":return[t.x2,t.y2];case"sw":return[t.x,t.y2]}}function d(){if(!n.aspectRatio){return g()}var a=n.aspectRatio,o=n.minSize[0]/X,s=n.maxSize[0]/X,c=n.maxSize[1]/G,u=i-e,f=r-t,l=Math.abs(u),d=Math.abs(f),h=l/d,v,w,y,m;if(s===0){s=H*10}if(c===0){c=D*10}if(h<a){w=r;y=d*a;v=u<0?e-y:y+e;if(v<0){v=0;m=Math.abs((v-e)/a);w=f<0?t-m:m+t}else if(v>H){v=H;m=Math.abs((v-e)/a);w=f<0?t-m:m+t}}else{v=i;m=l/a;w=f<0?t-m:t+m;if(w<0){w=0;y=Math.abs((w-t)*a);v=u<0?e-y:y+e}else if(w>D){w=D;y=Math.abs(w-t)*a;v=u<0?e-y:y+e}}if(v>e){if(v-e<o){v=e+o}else if(v-e>s){v=e+s}if(w>t){w=t+(v-e)/a}else{w=t-(v-e)/a}}else if(v<e){if(e-v<o){v=e-o}else if(e-v>s){v=e-s}if(w>t){w=t+(e-v)/a}else{w=t-(e-v)/a}}if(v<0){e-=v;v=0}else if(v>H){e-=v-H;v=H}if(w<0){t-=w;w=0}else if(w>D){t-=w-D;w=D}return b(p(e,t,v,w))}function h(e){if(e[0]<0)e[0]=0;if(e[1]<0)e[1]=0;if(e[0]>H)e[0]=H;if(e[1]>D)e[1]=D;return[Math.round(e[0]),Math.round(e[1])]}function p(e,t,i,n){var r=e,a=i,o=t,s=n;if(i<e){r=i;a=e}if(n<t){o=n;s=t}return[r,o,a,s]}function g(){var n=i-e,a=r-t,o;if(W&&Math.abs(n)>W){i=n>0?e+W:e-W}if(Y&&Math.abs(a)>Y){r=a>0?t+Y:t-Y}if(L/G&&Math.abs(a)<L/G){r=a>0?t+L/G:t-L/G}if(q/X&&Math.abs(n)<q/X){i=n>0?e+q/X:e-q/X}if(e<0){i-=e;e-=e}if(t<0){r-=t;t-=t}if(i<0){e-=i;i-=i}if(r<0){t-=r;r-=r}if(i>H){o=i-H;e-=o;i-=o}if(r>D){o=r-D;t-=o;r-=o}if(e>H){o=e-D;r-=o;t-=o}if(t>D){o=t-D;r-=o;t-=o}return b(p(e,t,i,r))}function b(e){return{x:e[0],y:e[1],x2:e[2],y2:e[3],w:e[2]-e[0],h:e[3]-e[1]}}return{flipCoords:p,setPressed:s,setCurrent:c,getOffset:u,moveOffset:f,getCorner:l,getFixed:d}}();var _=function(){var t=false,i=e("<div />").css({position:"absolute",zIndex:240,opacity:0}),r={top:u(),left:u().height(D),right:u().height(D),bottom:u()};function a(e,t){r.left.css({height:c(t)});r.right.css({height:c(t)})}function o(){return s($.getFixed())}function s(e){r.top.css({left:c(e.x),width:c(e.w),height:c(e.y)});r.bottom.css({top:c(e.y2),left:c(e.x),width:c(e.w),height:c(D-e.y2)});r.right.css({left:c(e.x2),width:c(H-e.x2)});r.left.css({width:c(e.x)})}function u(){return e("<div />").css({position:"absolute",backgroundColor:n.shadeColor||n.bgColor}).appendTo(i)}function f(){if(!t){t=true;i.insertBefore(F);o();et.setBgOpacity(1,0,1);B.hide();l(n.shadeColor||n.bgColor,1);if(et.isAwake()){h(n.bgOpacity,1)}else h(1,1)}}function l(e,t){gt(g(),e,t)}function d(){if(t){i.remove();B.show();t=false;if(et.isAwake()){et.setBgOpacity(n.bgOpacity,1,1)}else{et.setBgOpacity(1,1,1);et.disableHandles()}gt(I,0,1)}}function h(e,r){if(t){if(n.bgFade&&!r){i.animate({opacity:1-e},{queue:false,duration:n.fadeTime})}else i.css({opacity:1-e})}}function p(){n.shade?f():d();if(et.isAwake())h(n.bgOpacity)}function g(){return i.children()}return{update:o,updateRaw:s,getShades:g,setBgColor:l,enable:f,disable:d,resize:a,refresh:p,opacity:h}}();var et=function(){var t,i=370,r={},a={},o={},s=false;function f(t){var i=e("<div />").css({position:"absolute",opacity:n.borderOpacity}).addClass(u(t));P.append(i);return i}function l(t,i){var n=e("<div />").mousedown(w(t)).css({cursor:t+"-resize",position:"absolute",zIndex:i}).addClass("ord-"+t);if(Z.support){n.bind("touchstart.jcrop",Z.createDragger(t))}J.append(n);return n}function d(e){var t=n.handleSize,r=l(e,i++).css({opacity:n.handleOpacity}).addClass(u("handle"));if(t){r.width(t).height(t)}return r}function h(e){return l(e,i++).addClass("jcrop-dragbar")}function p(e){var t;for(t=0;t<e.length;t++){o[e[t]]=h(e[t])}}function g(e){var t,i;for(i=0;i<e.length;i++){switch(e[i]){case"n":t="hline";break;case"s":t="hline bottom";break;case"e":t="vline right";break;case"w":t="vline";break}r[e[i]]=f(t)}}function b(e){var t;for(t=0;t<e.length;t++){a[e[t]]=d(e[t])}}function v(e,t){if(!n.shade){B.css({top:c(-t),left:c(-e)})}A.css({top:c(t),left:c(e)})}function y(e,t){A.width(Math.round(e)).height(Math.round(t))}function x(){var e=$.getFixed();$.setPressed([e.x,e.y]);$.setCurrent([e.x2,e.y2]);C()}function C(e){if(t){return S(e)}}function S(e){var i=$.getFixed();y(i.w,i.h);v(i.x,i.y);if(n.shade)_.updateRaw(i);t||M();if(e){n.onSelect.call(vt,m(i))}else{n.onChange.call(vt,m(i))}}function z(e,i,r){if(!t&&!i)return;if(n.bgFade&&!r){F.animate({opacity:e},{queue:false,duration:n.fadeTime})}else{F.css("opacity",e)}}function M(){A.show();if(n.shade)_.opacity(E);else z(E,true);t=true}function O(){D();A.hide();if(n.shade)_.opacity(1);else z(1);t=false;n.onRelease.call(vt)}function j(){if(s){J.show()}}function H(){s=true;if(n.allowResize){J.show();return true}}function D(){s=false;J.hide()}function I(e){if(e){Q=true;D()}else{Q=false;H()}}function R(){I(false);x()}if(n.dragEdges&&e.isArray(n.createDragbars))p(n.createDragbars);if(e.isArray(n.createHandles))b(n.createHandles);if(n.drawBorders&&e.isArray(n.createBorders))g(n.createBorders);e(document).bind("touchstart.jcrop-ios",function(t){if(e(t.currentTarget).hasClass("jcrop-tracker"))t.stopPropagation()});var T=k().mousedown(w("move")).css({cursor:"move",position:"absolute",zIndex:360});if(Z.support){T.bind("touchstart.jcrop",Z.createDragger("move"))}P.append(T);D();return{updateVisible:C,update:S,release:O,refresh:x,isAwake:function(){return t},setCursor:function(e){T.css("cursor",e)},enableHandles:H,enableOnly:function(){s=true},showHandles:j,disableHandles:D,animMode:I,setBgOpacity:z,done:R}}();var tt=function(){var t=function(){},i=function(){},r=n.trackDocument;function a(t){T.css({zIndex:450});if(t)e(document).bind("touchmove.jcrop",f).bind("touchend.jcrop",l);else if(r)e(document).bind("mousemove.jcrop",s).bind("mouseup.jcrop",c)}function o(){T.css({zIndex:290});e(document).unbind(".jcrop")}function s(e){t(d(e));return false}function c(e){e.preventDefault();e.stopPropagation();if(V){V=false;i(d(e));if(et.isAwake()){n.onSelect.call(vt,m($.getFixed()))}o();t=function(){};i=function(){}}return false}function u(e,n,r){V=true;t=e;i=n;a(r);return false}function f(e){t(d(Z.cfilter(e)));return false}function l(e){return c(Z.cfilter(e))}function h(e){T.css("cursor",e)}if(!r){T.mousemove(s).mouseup(c).mouseout(c)}F.before(T);return{activateHandlers:u,setCursor:h}}();var it=function(){var t=e('<input type="radio" />').css({position:"fixed",left:"-120px",width:"12px"}).addClass("jcrop-keymgr"),i=e("<div />").css({position:"absolute",overflow:"hidden"}).append(t);function r(){if(n.keySupport){t.show();t.focus()}}function a(e){t.hide()}function o(e,t,i){if(n.allowMove){$.moveOffset([t,i]);et.updateVisible(true)}e.preventDefault();e.stopPropagation()}function c(e){if(e.ctrlKey||e.metaKey){return true}U=e.shiftKey?true:false;var t=U?10:1;switch(e.keyCode){case 37:o(e,-t,0);break;case 39:o(e,t,0);break;case 38:o(e,0,-t);break;case 40:o(e,0,t);break;case 27:if(n.allowSelect)et.release();break;case 9:return true}return false}if(n.keySupport){t.keydown(c).blur(a);if(s||!n.fixedSupport){t.css({position:"absolute",left:"-20px"});i.append(t).insertBefore(F)}else{t.insertBefore(F)}}return{watchKeys:r}}();function nt(e){I.removeClass().addClass(u("holder")).addClass(e)}function rt(e,t){var i=e[0]/X,r=e[1]/G,a=e[2]/X,o=e[3]/G;if(Q){return}var s=$.flipCoords(i,r,a,o),c=$.getFixed(),u=[c.x,c.y,c.x2,c.y2],f=u,l=n.animationDelay,d=s[0]-u[0],h=s[1]-u[1],p=s[2]-u[2],g=s[3]-u[3],b=0,v=n.swingSpeed;i=f[0];r=f[1];a=f[2];o=f[3];et.animMode(true);var w;function y(){window.setTimeout(m,l)}var m=function(){return function(){b+=(100-b)/v;f[0]=Math.round(i+b/100*d);f[1]=Math.round(r+b/100*h);f[2]=Math.round(a+b/100*p);f[3]=Math.round(o+b/100*g);if(b>=99.8){b=100}if(b<100){ot(f);y()}else{et.done();et.animMode(false);if(typeof t==="function"){t.call(vt)}}}}();y()}function at(e){ot([e[0]/X,e[1]/G,e[2]/X,e[3]/G]);n.onSelect.call(vt,m($.getFixed()));et.enableHandles()}function ot(e){$.setPressed([e[0],e[1]]);$.setCurrent([e[2],e[3]]);et.update()}function st(){return m($.getFixed())}function ct(){return $.getFixed()}function ut(e){h(e);bt()}function ft(){n.disabled=true;et.disableHandles();et.setCursor("default");tt.setCursor("default")}function lt(){n.disabled=false;bt()}function dt(){et.done();tt.activateHandlers(null,null)}function ht(){I.remove();M.show();M.css("visibility","visible");e(t).removeData("Jcrop")}function pt(e,t){et.release();ft();var i=new Image;i.onload=function(){var r=i.width;var a=i.height;var o=n.boxWidth;var s=n.boxHeight;F.width(r).height(a);F.attr("src",e);B.attr("src",e);y(F,o,s);H=F.width();D=F.height();B.width(H).height(D);T.width(H+R*2).height(D+R*2);I.width(H).height(D);_.resize(H,D);lt();if(typeof t==="function"){t.call(vt)}};i.src=e}function gt(e,t,i){var r=t||n.bgColor;if(n.bgFade&&f()&&n.fadeTime&&!i){e.animate({backgroundColor:r},{queue:false,duration:n.fadeTime})}else{e.css("backgroundColor",r)}}function bt(e){if(n.allowResize){if(e){et.enableOnly()}else{et.enableHandles()}}else{et.disableHandles()}tt.setCursor(n.allowSelect?"crosshair":"default");et.setCursor(n.allowMove?"move":"default");if(n.hasOwnProperty("trueSize")){X=n.trueSize[0]/H;G=n.trueSize[1]/D}if(n.hasOwnProperty("setSelect")){at(n.setSelect);et.done();delete n.setSelect}_.refresh();if(n.bgColor!=K){gt(n.shade?_.getShades():I,n.shade?n.shadeColor||n.bgColor:n.bgColor);K=n.bgColor}if(E!=n.bgOpacity){E=n.bgOpacity;if(n.shade)_.refresh();else et.setBgOpacity(E)}W=n.maxSize[0]||0;Y=n.maxSize[1]||0;q=n.minSize[0]||0;L=n.minSize[1]||0;if(n.hasOwnProperty("outerImage")){F.attr("src",n.outerImage);delete n.outerImage}et.refresh()}if(Z.support)T.bind("touchstart.jcrop",Z.newSelection);J.hide();bt(true);var vt={setImage:pt,animateTo:rt,setSelect:at,setOptions:ut,tellSelect:st,tellScaled:ct,setClass:nt,disable:ft,enable:lt,cancel:dt,release:et.release,destroy:ht,focus:it.watchKeys,getBounds:function(){return[H*X,D*G]},getWidgetSize:function(){return[H,D]},getScaleFactor:function(){return[X,G]},getOptions:function(){return n},ui:{holder:I,selection:A}};if(o)I.bind("selectstart",function(){return false});M.data("Jcrop",vt);return vt};e.fn.Jcrop=function(t,i){var n;this.each(function(){if(e(this).data("Jcrop")){if(t==="api")return e(this).data("Jcrop");else e(this).data("Jcrop").setOptions(t)}else{if(this.tagName=="IMG")e.Jcrop.Loader(this,function(){e(this).css({display:"block",visibility:"hidden"});n=e.Jcrop(this,t);if(e.isFunction(i))i.call(n)});else{e(this).css({display:"block",visibility:"hidden"});n=e.Jcrop(this,t);if(e.isFunction(i))i.call(n)}}});return this};e.Jcrop.Loader=function(t,i,n){var r=e(t),a=r[0];function o(){if(a.complete){r.unbind(".jcloader");if(e.isFunction(i))i.call(a)}else window.setTimeout(o,50)}r.bind("load.jcloader",o).bind("error.jcloader",function(t){r.unbind(".jcloader");if(e.isFunction(n))n.call(a)});if(a.complete&&e.isFunction(i)){r.unbind(".jcloader");i.call(a)}};e.Jcrop.defaults={allowSelect:true,allowMove:true,allowResize:true,trackDocument:true,baseClass:"jcrop",addClass:null,bgColor:"black",bgOpacity:.6,bgFade:false,borderOpacity:.4,handleOpacity:.5,handleSize:null,aspectRatio:0,keySupport:true,createHandles:["n","s","e","w","nw","ne","se","sw"],createDragbars:["n","s","e","w"],createBorders:["n","s","e","w"],drawBorders:true,dragEdges:true,fixedSupport:true,touchSupport:null,shade:null,boxWidth:0,boxHeight:0,boundary:2,fadeTime:400,animationDelay:20,swingSpeed:3,minSelect:[0,0],maxSize:[0,0],minSize:[0,0],onChange:function(){},onSelect:function(){},onDblClick:function(){},onRelease:function(){}}})(jQuery);