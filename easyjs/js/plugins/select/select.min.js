(function(e){e.select=e.select||{};e.select.defaults={title:"选择组件",initJson:[],itemName:"name",itemValue:"pkId",maxSelectNum:null,error:null,items:[]};e.select.defaultItems={title:"",leftUrl:"",rightUrl:"",idFieldName:"pkId",textFieldName:"name"};e.select.open=function(t,i){var a=[];a.push('<div id="selectPlugin" class="l-dialog-hack">');a.push("</div>");a.push('<script type="text/javascript">');a.push('  $("#selectPlugin").selectDialog('+e.util.stringify(t)+");");a.push("</script>");var s=top.$.ligerDialog.open({title:t.title,content:a.join(""),width:630,height:488,isNeedNoPaddingClass:true,buttons:[{text:"确定",onclick:function(a,s){var l=e.select.submit(t,i);if(l){s.close()}}},{text:"取消",onclick:function(e,t){t.close()}}]})};e.select.submit=function(t,i){var a=e("li.single",e("div.show_select"));var s=a.length;if(t.maxSelectNum&&s>t.maxSelectNum){top.$.ligerDialog.error("您最多可以选中"+t.maxSelectNum+"项!");return false}var l=[];var n=[];e(a).each(function(t,i){var a=e(i).attr("id").substr("t-selected-item-".length);var s=e("span",e(i)).text();l.push(s);n.push(a)});e(i).val(l.join(","));e(i).next().val(n.join(","));return true};e.fn.selectDialog=function(t){this.each(function(){t=e.extend({},e.select.defaults,t||{});var i={initSelectArea:function(){var t=[];t.push('<div class="user_stats_div">已经选择<b id="t-selectCount">0</b>个选项</div>');t.push('     <div class="show_select">');t.push('         <ul class="t-selected-ul">');t.push("         </ul>");t.push("     </div>");t.push("</div>");e("#selectArea").html(t.join(""));i.initSelectedItems()},initSelectedItems:function(){e(t.initJson).each(function(e,a){i.addTopItem(a[t.itemName],a[t.itemValue])})},addTopItem:function(t,a){var s='<li id="t-selected-item-'+a+'" class="single"><span>'+t+'</span><a class="t-delete-item"></a></li>';e(".t-selected-ul").append(s);i.updateSelectedCount();e(".t-delete-item",i.tabs).bind("click",function(){var t=e(this).parent();var a=t.attr("id").substr("t-selected-item-".length);var s=e("#"+a,i.tabs).parent();i.removeItem(s)})},updateSelectedCount:function(){var t=e("li.single",i.tabs).size();e("#t-selectCount").html(t);if(t==i.totalCount){e("#selectAll").attr("checked","checked")}else{e("#selectAll").removeAttr("checked")}},addItem:function(t,a){var s=e('<div tabid="select-'+t+'"></div>');var l=[];l.push('<div class="tree_div">');l.push('  <ul id="select-'+t+'"  style="height:285px">');l.push("  </ul>");l.push("</div>");l.push('<div class="chose_div">');l.push('  <div class="toolbar_query">');l.push("      <li>");l.push('          <div class="btn_query">');l.push('              <input id="keyword" name="keyword" type="text"/>');l.push('              <a href="javascript:void(0);" class="r-query-button" title="查询"/>');l.push("          </div>");l.push("      </li>");l.push("      <li>");l.push('          <label for="selectAll">');l.push('              <input name="selectAll" id="selectAll" type="checkbox" value=""/>&nbsp;全选&nbsp;');l.push("          </label>");l.push("      </li>");l.push("  </div>");l.push('  <div class="list">');l.push("  </div>");l.push('  <div class="page_blue">');l.push("  </div>");l.push("</div>");s.html(l.join(""));e("#content",i.tabs).append(s);s.attr("title",a.title);s.attr("leftUrl",a.leftUrl);s.attr("rightUrl",a.rightUrl)},loadRightData:function(a,s){i.clearHtml();i.loading.show();var l=s?"POST":"GET";s=s||[];e.ajax({type:l,url:a,dataType:"json",data:s,success:function(e){if(!e)return;i.loading.hide();i.setRightHtml(a,e)},error:function(e,a,s){i.loading.hide();if(t.error)t.error(e,a,s);else alert("error")}})},clearHtml:function(){e(".list",i.tabs).empty();e(".page_blue",i.tabs).empty();e("#selectAll",i.tabs).removeAttr("checked")},setSelectAll:function(t){if(t==i.getSelectItemsSize()){e("#selectAll").attr("checked","checked")}else{e("#selectAll").removeAttr("checked")}},getSelectItemsSize:function(){var t=e("li.single",e("div.show_select"));return t.size()},setRightHtml:function(a,s){var l=s.paginationSupport;i.totalCount=l.totalRow;i.setSelectAll(i.totalCount);var n=null;if(l!=null)n=l.items;var r=["<ul>"];if(l&&n.length>0){for(var c=0;c<n.length;c++){var u=n[c][t.itemName];var d=n[c][t.itemValue];var p="";var o="";e("li.single",i.tabs).each(function(t){var i=e(this).attr("id").substr("t-selected-item-".length);if(i==d){p="checked";o=" selected"}});r.push('<li class="r-selected-li'+o+'" title="'+u+'">');r.push('     <input class="r-selected-item" '+p+' type="checkbox" value="'+d+'"  id="'+d+'" text="'+u+'"/>');r.push(u);r.push("</li>")}r.push("</ul>");e(".list",i.tabs).html(r.join(""));i.setPage(a,l)}},setPage:function(t,a){var s=[];if(a!=null&&a.pageSize>=1){if(a.currentIndex!=1){s.push('<a class="page" href="javascript:void(0);" page="1"> 首页 </a>');s.push('<a class="page" href="javascript:void(0);" page="'+a.previousIndex+'"> &lt; </a>')}for(var l=a.startIndexOnShow;l<=a.endIndexOnShow;l++){if(l==a.currentIndex){s.push('<span class="current">'+l+"</span>")}else{s.push('<a class="page" href="javascript:void(0);" page="'+l+'"> '+l+" </a>")}}if(a.currentIndex<a.endIndex){s.push('<a class="page" href="javascript:void(0);" page="'+a.nextIndex+'"> &gt; </a>');s.push('<a class="page" href="javascript:void(0);" page="'+a.endIndex+'"> 尾页 </a>')}e(".page_blue",i.tabs).html(s.join(""));i.initEvents(t)}},selectItem:function(t){var a=e(".r-selected-item",t);if(!t.hasClass("selected")){a.attr("checked","checked");t.addClass("selected");i.addTopItem(a.attr("text"),a.attr("id"))}},removeItem:function(t){var a=e(".r-selected-item",t);if(t.hasClass("selected")){a.removeAttr("checked");t.removeClass("selected");e("#t-selected-item-"+a.attr("id"),i.tabs).remove();i.updateSelectedCount()}},initEvents:function(t){e(".page",i.tabs).unbind("click").bind("click",function(){var a=e(".r-query-button",i.tabs);var s=e(this).attr("page");var l=a.attr("pkId")==null?"-1":a.attr("pkId");var n=a.attr("keyword")==null?"":a.attr("keyword");var r="pkId="+l+"&keyword="+n+"&page="+s;i.loadRightData(t,r)});e(".r-query-button",i.tabs).bind("click",function(){var a=e(this).attr("pkId")==null?"-1":e(this).attr("pkId");var s=e(this).prev().val();var l="pkId="+a+"&keyword="+s;i.loadRightData(t,l)});e(".r-selected-li",i.tabs).bind("click",function(){var t=e(this).hasClass("selected");if(t){i.removeItem(e(this))}else{i.selectItem(e(this))}});e("#selectAll").bind("click",function(){var t=e(this).attr("checked");if(t){e(".r-selected-li",e(this).parents(".chose_div")).each(function(t,a){i.selectItem(e(a))})}else{e(".r-selected-li",e(this).parents(".chose_div")).each(function(t,a){i.removeItem(e(a))})}})}};i.tabs=e(this);i.totalCount=0;var a=[];a.push('<div id="selectArea" style="width:600px;height:100px;">');a.push("</div>");a.push('<div class="tab_module">');a.push('    <div id="content">');a.push("    </div>");a.push("</div>");var s=e(a.join(""));i.tabs.append(s);i.initSelectArea();if(t.items){e(t.items).each(function(t,a){a=e.extend({},e.select.defaultItems,a||{});i.addItem(t,a)})}i.loading=e("<div class='l-tree-loading'></div>");e("#content",i.tabs).ligerTab({onAfterSelectTabItem:function(t){var a=e("li[tabid="+t+"]");var s=a.attr("leftUrl");var l=a.attr("rightUrl");var n="pkId";var r="name";i.loadRightData(l,"");e("#"+t).ligerTree({idFieldName:n,textFieldName:r,checkbox:false,url:s,onSelect:function(t){e(".r-query-button",i.tabs).attr("pkId",t.data.pkId);var a="pkId="+t.data.pkId;i.loadRightData(l,a)}});e("li",e("#"+t)).each(function(){});e(".r-query-button",i.tabs).attr("pkId","-1")}});if(this.id==undefined)this.id="selectPlugins"+(new Date).getTime()})};e.fn.select=function(t){this.each(function(){t=e.extend({},e.select.defaults,t||{});var i={initEvent:function(){i.img.bind("click",function(){var a=i.input.val().split(",");var s=i.input.next().val().split(",");var l=new Array;for(var n in s){var r=new Object;r[t.itemName]=a[n];r[t.itemValue]=s[n];if(s[n]!="")l[n]=r}t.initJson=l;e.select.open(t,i.input)})}};i.input=e(this);i.inputId=i.input.attr("id");i.inputName=i.input.attr("name")?i.input.attr("name"):i.inputId;i.input.attr("name",i.inputName+"_val");i.input.attr("id",i.inputId+"_val");if(this.tagName.toLowerCase()=="input"||this.tagName.toLowerCase()=="textarea"){this.readOnly=true;i.selectDiv=i.input.wrap('<div class="select_div"></div>').parent();if(this.tagName.toLowerCase()=="input"){i.userDiv=i.selectDiv.wrap('<div class="user_div_input float_left"></div>').parent()}else{i.input.attr("rows","3");i.userDiv=i.selectDiv.wrap('<div class="user_div_textarea float_left"></div>').parent()}i.img=i.userDiv.append('<div class="select_img"><a class="l-click-open" href="#"></a></div>').find(".select_img");i.input.after('<input type="hidden" name="'+i.inputId+'" value=""/>');var a="";var s="";if(t.initJson){e(t.initJson).each(function(i,l){if(l!=null){a+=l[t.rightItemName];s+=l[t.rightItemValue];if(i<e(t.initJson).size()-1){a+=",";s+=","}}});e(this).val(a);e(this).next().val(s);i.initEvent()}}else{alert("只有input和textarea才能是选择组件的容器!")}})}})(jQuery);