if(typeof LigerUIManagers=="undefined")LigerUIManagers={};(function($){$.fn.ligerGetTreeManager=function(){return LigerUIManagers[this[0].id+"_Tree"]};$.ligerDefaults=$.ligerDefaults||{};$.ligerDefaults.Tree={url:null,data:null,checkbox:true,autoCheckboxEven:true,parentIcon:"folder",childIcon:"leaf",textFieldName:"treeName",attribute:["id","url"],treeLine:true,nodeWidth:90,statusName:"__status",isLeaf:null,single:false,onBeforeExpand:function(){},onContextmenu:function(){},onExpand:function(){},onBeforeCollapse:function(){},onCollapse:function(){},onBeforeSelect:function(){},onSelect:function(){},onBeforeCancelSelect:function(){},onCancelselect:function(){},onCheck:function(){},onSuccess:function(){},onError:function(){},onClick:function(){},idFieldName:"pkId",parentIDFieldName:null,topParentIDValue:0,onBeforeAppend:function(){},onAppend:function(){},onAfterAppend:function(){},onRClickToSelect:true,slide:true,disableFlag:"hasRole"};$.tree={};$.tree.addNode=function(e,t,a){if(a){location.reload()}else{var l=$(".l-tree").ligerGetTreeManager();var n=l.getSelected();var r=[];r.push({text:t});if(n){l.append(n.target,r)}else{l.append(null,r)}}};$.tree.editNode=function(e,t,a){if(a){location.reload()}else{var l=$(".l-tree").ligerGetTreeManager();var n=l.getSelected();if(n){l.update(n.target,{text:t})}else{alert("请先选择节点")}}};$.tree.deleteNode=function(treeId,url,execFunc){var manager=$("#"+treeId).ligerGetTreeManager();if(!manager)return;var notes=manager.getChecked();var ids="";var names="";if(notes==null||notes.length==0){notes=manager.getSelected();if(notes!=null){ids+=notes.data.pkId+",";names+=notes.data.treeNodeName}}else{for(var i=0;i<notes.length;i++){ids+=notes[i].data.pkId+",";names+=notes[i].data.treeNodeName+","}}if(ids==""){top.$.ligerDialog.alert("请选择要删除的数据！","提示","warn");return}top.$.ligerDialog.confirm("确定要删除“"+names+"”吗？",function(r){if(r){$.ajax({type:"post",url:url?url:"",data:"ids="+ids,success:function(ret){var returnValue=eval("("+$.trim(ret)+")");if(execFunc&&typeof execFunc=="function")execFunc($.trim(ret));else if(returnValue.status==1){manager.deleteSelectedRow()}}})}})};$.tree.moveUp=function(e){if(e){location.reload()}else{var t=$(".l-tree").ligerGetTreeManager();var a=t.getSelected();if(a){t.moveUp()}else{alert("请先选择节点")}}};$.tree.moveDown=function(e){if(e){location.reload()}else{var t=$(".l-tree").ligerGetTreeManager();var a=t.getSelected();if(a){t.moveDown()}else{alert("请先选择节点")}}};$.fn.ligerTree=function(e){if(e.single)e.autoCheckboxEven=false;this.each(function(){e=$.extend({},$.ligerDefaults.Tree,e||{});if(this.usedTree)return;if($(this).hasClass("l-hidden")){return}var t={getData:function(){return t.data},hasChildren:function(t){if(e.isLeaf)return e.isLeaf(t);return t.children&&t.children!=""?true:false},getParentTreeItem:function(e,t){var a=$(e);if(a.parent().hasClass("l-tree"))return null;if(t==undefined){if(a.parent().parent("li").length==0)return null;return a.parent().parent("li")[0]}var l=parseInt(a.attr("outlinelevel"));var n=a;for(var r=l-1;r>=t;r--){n=n.parent().parent("li")}return n[0]},getChecked:function(){if(!e.checkbox)return null;var l=[];$(".l-checkbox-checked",t.tree).parent().parent("li").each(function(){var e=parseInt($(this).attr("treedataindex"));l.push({target:this,data:a.getDataNodeByTreeDataIndex(t.data,e)})});return l},getSelected:function(){var e={};e.target=$(".l-selected",t.tree).parent("li")[0];if(e.target){var l=parseInt($(e.target).attr("treedataindex"));e.data=a.getDataNodeByTreeDataIndex(t.data,l);return e}return null},moveUp:function(){var e=$(".l-selected",t.tree).parent("li");e.prev().before(e);return null},moveDown:function(){var e=$(".l-selected",t.tree).parent("li");e.next().after(e);return null},getSelectedPrev:function(){var e={};e.target=$(".l-selected",t.tree).parent("li").prev()[0];if(e.target){var l=parseInt($(e.target).attr("treedataindex"));e.data=a.getDataNodeByTreeDataIndex(t.data,l);return e}return null},getSelectedNext:function(){var e={};e.target=$(".l-selected",t.tree).parent("li").next()[0];if(e.target){var l=parseInt($(e.target).attr("treedataindex"));e.data=a.getDataNodeByTreeDataIndex(t.data,l);return e}return null},upgrade:function(e){$(".l-note",e).each(function(){$(this).removeClass("l-note").addClass("l-expandable-open")});$(".l-note-last",e).each(function(){$(this).removeClass("l-note-last").addClass("l-expandable-open")});$("."+a.getChildNodeClassName(),e).each(function(){$(this).removeClass(a.getChildNodeClassName()).addClass(a.getParentNodeClassName(true))})},demotion:function(e){if(!e&&e[0].tagName.toLowerCase()!="li")return;var t=$(e).hasClass("l-last");$(".l-expandable-open",e).each(function(){$(this).removeClass("l-expandable-open").addClass(t?"l-note-last":"l-note")});$(".l-expandable-close",e).each(function(){$(this).removeClass("l-expandable-close").addClass(t?"l-note-last":"l-note")});$("."+a.getParentNodeClassName(true),e).each(function(){$(this).removeClass(a.getParentNodeClassName(true)).addClass(a.getChildNodeClassName())})},collapseAll:function(){$(".l-expandable-open",t.tree).click()},expandAll:function(){$(".l-expandable-close",t.tree).click()},loadData:function(a,l,n){t.loading.show();var r=n?"post":"get";n=n||[];$.ajax({type:r,url:l,data:n,dataType:"json",success:function(l){if(!l)return;t.loading.hide();t.append(a,l.Rows);if(e.onSuccess)e.onSuccess(l.Rows)},error:function(a,l,n){try{t.loading.hide();if(e.onError)e.onError(a,l,n)}catch(r){}}})},clear:function(){$("> li",t.tree).each(function(){t.remove(this)})},remove:function(l){var n=parseInt($(l).attr("treedataindex"));var r=a.getDataNodeByTreeDataIndex(t.data,n);if(r)a.setTreeDataStatus([r],"delete");var s=t.getParentTreeItem(l);if(e.checkbox){$(".l-checkbox",l).remove();a.setParentCheckboxStatus($(l))}$(l).remove();if(s==null){s=t.tree.parent()}var i=$("> ul > li",s).length;if(i>0){$("> ul > li",s).each(function(e,t){if(e==0&&!$(this).hasClass("l-first"))$(this).addClass("l-first");if(e==i-1&&!$(this).hasClass("l-last"))$(this).addClass("l-last");if(e==0&&e==i-1&&!$(this).hasClass("l-onlychild"))$(this).addClass("l-onlychild");$("> div .l-note,> div .l-note-last",this).removeClass("l-note l-note-last").addClass(e==i-1?"l-note-last":"l-note");a.setTreeItem(this,{isLast:e==i-1})})}},update:function(l,n){var r=parseInt($(l).attr("treedataindex"));nodedata=a.getDataNodeByTreeDataIndex(t.data,r);for(var s in n){nodedata[s]=n[s];if(s==e.textFieldName){$("> .l-body > span",l).text(n[s])}}},append:function(l,n){if(e.onBeforeAppend&&e.onBeforeAppend(l,n)==false)return false;if(!n||!n.length)return false;if(e.idFieldName&&e.parentIDFieldName)n=a.convertData(n);a.addTreeDataIndexToData(n);a.setTreeDataStatus(n,"add");e.onAppend&&e.onAppend(l,n);a.appendData(l,n);if(!l){if($("> li:last",t.tree).length>0)a.setTreeItem($("> li:last",t.tree)[0],{isLast:false});var r=a.getTreeHTMLByData(n,1,[],true);r[r.length-1]=r[0]="";t.tree.append(r.join(""));$(".l-body",t.tree).hover(function(){$(this).addClass("l-over")},function(){$(this).removeClass("l-over")});a.upadteTreeWidth();e.onAfterAppend&&e.onAfterAppend(l,n);return}var s=$(l);var i=parseInt(s.attr("outlinelevel"));var d=$("> ul",s).length>0;if(!d){s.append("<ul class='l-children'></ul>");t.upgrade(l)}if($("> .l-children > li:last",s).length>0)a.setTreeItem($("> .l-children > li:last",s)[0],{isLast:false});var o=[];for(var c=1;c<=i-1;c++){var h=$(t.getParentTreeItem(l,c));o.push(h.hasClass("l-last"))}o.push(s.hasClass("l-last"));var r=a.getTreeHTMLByData(n,i+1,o,true);r[r.length-1]=r[0]="";$(">.l-children",l).append(r.join(""));a.upadteTreeWidth();$(">.l-children .l-body",l).hover(function(){$(this).addClass("l-over")},function(){$(this).removeClass("l-over")});e.onAfterAppend&&e.onAfterAppend(l,n)},cancelSelect:function(l){var n=$(l);var r=parseInt(n.attr("treedataindex"));var s=a.getDataNodeByTreeDataIndex(t.data,r);var i=$(">div:first",n);if(e.checkbox)$(".l-checkbox",i).removeClass("l-checkbox-checked").addClass("l-checkbox-unchecked");else i.removeClass("l-selected");e.onCancelSelect&&e.onCancelSelect({data:s,target:n[0]})},selectNode:function(l){var n=null;if(typeof l=="function"){n=l}else if(typeof l=="object"){var r=$(l);var s=parseInt(r.attr("treedataindex"));var i=a.getDataNodeByTreeDataIndex(t.data,s);var d=$(">div:first",r);if(e.checkbox)$(".l-checkbox",d).removeClass("l-checkbox-unchecked").addClass("l-checkbox-checked");else d.addClass("l-selected");e.onSelect&&e.onSelect({data:i,target:r[0]});return}else{n=function(t){if(!t[e.idFieldName])return false;return t[e.idFieldName].toString()==l.toString()}}$("li",t.tree).each(function(){var e=$(this);var l=parseInt(e.attr("treedataindex"));var r=a.getDataNodeByTreeDataIndex(t.data,l);if(n(r,l)){t.selectNode(this)}else{t.cancelSelect(this)}})},getTextByID:function(a){var l=t.getDataByID(a);if(!l)return null;return l[e.textFieldName]},getDataByID:function(l){var n=null;$("li",t.tree).each(function(){if(n)return;var r=$(this);var s=parseInt(r.attr("treedataindex"));var i=a.getDataNodeByTreeDataIndex(t.data,s);if(i[e.idFieldName].toString()==l.toString()){n=i}});return n}};var a={getDataNodeByTreeDataIndex:function(e,t){for(var l=0;l<e.length;l++){if(e[l].treedataindex==t)return e[l];if(e[l].children){var n=a.getDataNodeByTreeDataIndex(e[l].children,t);if(n)return n}}return null},setTreeDataStatus:function(t,l){$(t).each(function(){this[e.statusName]=l;if(this.children){a.setTreeDataStatus(this.children,l)}})},addTreeDataIndexToData:function(e){$(e).each(function(){if(this.treedataindex!=undefined)return;this.treedataindex=t.treedataindex++;if(this.children){a.addTreeDataIndexToData(this.children)}})},appendData:function(e,l){var n=parseInt($(e).attr("treedataindex"));var r=a.getDataNodeByTreeDataIndex(t.data,n);if(t.treedataindex==undefined)t.treedataindex=0;if(r&&r.children==undefined)r.children=[];$(l).each(function(e,a){if(r)r.children[r.children.length]=$.extend({},a);else t.data[t.data.length]=$.extend({},a)})},setTreeItem:function(e,t){if(!t)return;var a=$(e);var l=parseInt(a.attr("outlinelevel"));if(t.isLast!=undefined){if(t.isLast==true){a.removeClass("l-last").addClass("l-last");$("> div .l-note",a).removeClass("l-note").addClass("l-note-last");$(".l-children li",a).find(".l-box:eq("+(l-1)+")").removeClass("l-line")}else if(t.isLast==false){a.removeClass("l-last");$("> div .l-note-last",a).removeClass("l-note-last").addClass("l-note");$(".l-children li",a).find(".l-box:eq("+(l-1)+")").removeClass("l-line").addClass("l-line")}}},upadteTreeWidth:function(){},getChildNodeClassName:function(t){var a="l-tree-icon-"+e.childIcon;var l=t.showInNavigation;if(l&&l==0&&t.enableStatus==0)a+="-dh";else if(l&&l==0)a+="-h";else if(t.enableStatus==0)a+="-d";return a},getParentNodeClassName:function(t,a){var l="l-tree-icon-"+e.parentIcon;var n=t.showInNavigation;if(a)l+="-open";if(n&&n==0&&t.enableStatus==0)l+="-dh";else if(n&&n==0)l+="-h";else if(t.enableStatus==0)l+="-d";return l},getTreeHTMLByData:function(l,n,r,s){if(t.maxOutlineLevel<n)t.maxOutlineLevel=n;r=r||[];n=n||1;var i=[];if(!s)i.push('<ul class="l-children" style="display:none">');else i.push("<ul class='l-children'>");for(var d=0;d<l.length;d++){var o=d==0;var c=d==l.length-1;var h=true;if(l[d].isexpand==false||l[d].isexpand=="false")h=false;i.push("<li ");if(l[d].treedataindex!=undefined)i.push('treedataindex="'+l[d].treedataindex+'" ');if(h)i.push("isexpand="+l[d].isexpand+" ");i.push("outlinelevel="+n+" ");for(var u=0;u<t.sysAttribute.length;u++){if($(this).attr(t.sysAttribute[u]))l[dataindex][t.sysAttribute[u]]=$(this).attr(t.sysAttribute[u])}for(var u=0;u<e.attribute.length;u++){if(l[d][e.attribute[u]])i.push(e.attribute[u]+'="'+l[d][e.attribute[u]]+'" ')}i.push('class="');o&&i.push("l-first ");c&&i.push("l-last ");o&&c&&i.push("l-onlychild ");i.push('"');i.push(">");i.push('<div class="l-body">');for(var f=0;f<=n-2;f++){if(r[f])i.push('<div class="l-box"></div>');else i.push('<div class="l-box l-line"></div>')}if(t.hasChildren(l[d])){if(h)i.push('<div class="l-box l-expandable-open"></div>');else i.push('<div class="l-box l-expandable-close"></div>');if(e.checkbox){if(l[d].ischecked)i.push('<div class="l-box l-checkbox l-checkbox-checked"></div>');else i.push('<div class="l-box l-checkbox l-checkbox-unchecked"></div>')}e.parentIcon&&!h&&i.push('<div class="l-box '+a.getParentNodeClassName(l[d],false)+'"></div>');e.parentIcon&&h&&i.push('<div class="l-box '+a.getParentNodeClassName(l[d],true)+'"></div>')}else{if(c)i.push('<div class="l-box l-note-last"></div>');else i.push('<div class="l-box l-note"></div>');if(e.checkbox){if(l[d].ischecked)i.push('<div class="l-box l-checkbox l-checkbox-checked"></div>');else i.push('<div class="l-box l-checkbox l-checkbox-unchecked"></div>')}e.childIcon&&i.push('<div class="l-box '+a.getChildNodeClassName(l[d])+'"></div>')}if(l[d][e.disableFlag]==false){i.push('<span class="gray">'+l[d][e.textFieldName]+"</span></div>")}else{i.push("<span>"+l[d][e.textFieldName]+"</span></div>")}if(t.hasChildren(l[d])){var p=[];for(var f=0;f<r.length;f++){p.push(r[f])}p.push(c);i.push(a.getTreeHTMLByData(l[d].children,n+1,p,h).join(""))}i.push("</li>")}i.push("</ul>");return i},getDataByTreeHTML:function(l){var n=[];$("> li",l).each(function(l,r){var s=n.length;n[s]={treedataindex:t.treedataindex++};n[s][e.textFieldName]=$("> span,> a",this).html();for(var i=0;i<t.sysAttribute.length;i++){if($(this).attr(t.sysAttribute[i]))n[s][t.sysAttribute[i]]=$(this).attr(t.sysAttribute[i])}for(var i=0;i<e.attribute.length;i++){if($(this).attr(e.attribute[i]))n[s][e.attribute[i]]=$(this).attr(e.attribute[i])}if($("> ul",this).length>0){n[s].children=a.getDataByTreeHTML($("> ul",this))}});return n},applyTree:function(){t.data=a.getDataByTreeHTML(t.tree);var e=a.getTreeHTMLByData(t.data,1,[],true);e[e.length-1]=e[0]="";t.tree.html(e.join(""));a.upadteTreeWidth();$(".l-body",t.tree).hover(function(){$(this).addClass("l-over")},function(){$(this).removeClass("l-over")})},applyTreeEven:function(e){$("> .l-body",e).hover(function(){$(this).addClass("l-over")},function(){$(this).removeClass("l-over")})},setTreeEven:function(){e.onContextmenu&&t.tree.bind("contextmenu",function(l){var n=l.target||l.srcElement;var r=null;if(n.tagName.toLowerCase()=="a"||n.tagName.toLowerCase()=="span"||$(n).hasClass("l-box"))r=$(n).parent().parent();else if($(n).hasClass("l-body"))r=$(n).parent();else if(n.tagName.toLowerCase()=="li")r=$(n);if(!r)return;if($("span",r).hasClass("gray")){return}if(e.onRClickToSelect){$(".l-body",t.tree).removeClass("l-selected");$(">div:first",r).addClass("l-selected")}var s=parseInt(r.attr("treedataindex"));var i=a.getDataNodeByTreeDataIndex(t.data,s);return e.onContextmenu({data:i,target:r[0]},l)});t.tree.click(function(l){var n=l.target||l.srcElement;var r=null;if(n.tagName.toLowerCase()=="a"||n.tagName.toLowerCase()=="span"||$(n).hasClass("l-box"))r=$(n).parent().parent();else if($(n).hasClass("l-body"))r=$(n).parent();else r=$(n);if(!r)return;if($("span",r).hasClass("gray")){return}var s=parseInt(r.attr("treedataindex"));var i=a.getDataNodeByTreeDataIndex(t.data,s);var d=$("div.l-body:first",r).find("div.l-expandable-open:first,div.l-expandable-close:first");var o=$(n).hasClass("l-expandable-open")||$(n).hasClass("l-expandable-close");if(!$(n).hasClass("l-checkbox")&&!o){if(e.onBeforeSelect&&e.onBeforeSelect({data:i,target:r[0]})==false)return false;$(".l-body",t.tree).removeClass("l-selected");$(">div:first",r).addClass("l-selected");e.onSelect&&e.onSelect({data:i,target:r[0]})}if($(n).hasClass("l-checkbox")){if(e.autoCheckboxEven){if($(n).hasClass("l-checkbox-unchecked")){$(n).removeClass("l-checkbox-unchecked").addClass("l-checkbox-checked");$(".l-children .l-checkbox",r).removeClass("l-checkbox-incomplete l-checkbox-unchecked").addClass("l-checkbox-checked");e.onCheck&&e.onCheck({data:i,target:r[0]},true)}else if($(n).hasClass("l-checkbox-checked")){$(n).removeClass("l-checkbox-checked").addClass("l-checkbox-unchecked");$(".l-children .l-checkbox",r).removeClass("l-checkbox-incomplete l-checkbox-checked").addClass("l-checkbox-unchecked");e.onCheck&&e.onCheck({data:i,target:r[0]},false)}else if($(n).hasClass("l-checkbox-incomplete")){$(n).removeClass("l-checkbox-incomplete").addClass("l-checkbox-checked");$(".l-children .l-checkbox",r).removeClass("l-checkbox-incomplete l-checkbox-unchecked").addClass("l-checkbox-checked");e.onCheck&&e.onCheck({data:i,target:r[0]},true)}a.setParentCheckboxStatus(r)}else{if($(n).hasClass("l-checkbox-unchecked")){$(n).removeClass("l-checkbox-unchecked").addClass("l-checkbox-checked");if(e.single){$(".l-checkbox",t.tree).not(n).removeClass("l-checkbox-checked").addClass("l-checkbox-unchecked")}e.onCheck&&e.onCheck({data:i,target:r[0]},true)}else if($(n).hasClass("l-checkbox-checked")){$(n).removeClass("l-checkbox-checked").addClass("l-checkbox-unchecked");e.onCheck&&e.onCheck({data:i,target:r[0]},false)}}}else if(d.hasClass("l-expandable-open")&&o){if(e.onBeforeCollapse&&e.onBeforeCollapse({data:i,target:r[0]})==false)return false;if(!(n.tagName.toLowerCase()=="span")){d.removeClass("l-expandable-open").addClass("l-expandable-close");if(e.slide)$("> .l-children",r).slideToggle("fast");else $("> .l-children",r).toggle();$("> div ."+a.getParentNodeClassName(true),r).removeClass(a.getParentNodeClassName(true)).addClass(a.getParentNodeClassName())}e.onCollapse&&e.onCollapse({data:i,target:r[0]})}else if(d.hasClass("l-expandable-close")&&o){if(e.onBeforeExpand&&e.onBeforeExpand({data:i,target:r[0]})==false)return false;var c=function(){e.onExpand&&e.onExpand({data:i,target:r[0]})};if(!(n.tagName.toLowerCase()=="span")){d.removeClass("l-expandable-close").addClass("l-expandable-open");if(e.slide){$("> .l-children",r).slideToggle("fast",c)}else{$("> .l-children",r).toggle();c()}$("> div ."+a.getParentNodeClassName(),r).removeClass(a.getParentNodeClassName()).addClass(a.getParentNodeClassName(true))}}e.onClick&&e.onClick({data:i,target:r[0]})})},setParentCheckboxStatus:function(e){var t=$(".l-checkbox-unchecked",e.parent()).length==0;var l=$(".l-checkbox-checked",e.parent()).length==0;if(t){e.parent().prev().find(".l-checkbox").removeClass("l-checkbox-unchecked l-checkbox-incomplete").addClass("l-checkbox-checked")}else if(l){e.parent().prev().find("> .l-checkbox").removeClass("l-checkbox-checked l-checkbox-incomplete").addClass("l-checkbox-unchecked")}else{e.parent().prev().find("> .l-checkbox").removeClass("l-checkbox-unchecked l-checkbox-checked").addClass("l-checkbox-incomplete")}if(e.parent().parent("li").length>0)a.setParentCheckboxStatus(e.parent().parent("li"))},convertData:function(t){if(!t||!t.length)return[];var a=function(a){if(a==e.topParentIDValue)return false;for(var l=0;l<t.length;l++){if(t[l][e.idFieldName]==a)return false}return true};var l=0;for(var n=0;n<t.length;n++){if(a(t[n][e.parentIDFieldName]))l++}var r=[];var s=t.length;var i=0;var d=0;var o=function(t,a){if(!t.length)return null;for(var l=0;l<t.length;l++){if(t[l][e.idFieldName]==a)return t[l];if(t[l].children){var n=o(t[l].children,a);if(n)return n}}return null};var c=function(e,t){e.push($.extend({},t));i++};while(i+l<s){var h=t[d];var u=h[e.idFieldName];var f=h[e.parentIDFieldName];if(f==e.topParentIDValue){o(r,u)==null&&c(r,h)}else{var p=o(r,f);if(p&&o(r,u)==null){p.children=p.children||[];c(p.children,h)}}d=(d+1)%s}return r}};if(!$(this).hasClass("l-tree"))$(this).addClass("l-tree");$(this).width($(this).parent("div").width()-12);$(this).height($(this).parent("div").height()-15);t.tree=$(this);if(!e.treeLine)t.tree.addClass("l-tree-noline");t.sysAttribute=["isexpand","ischecked","href","style"];t.loading=$("<div class='l-tree-loading'></div>");t.tree.after(t.loading);t.data=[];t.maxOutlineLevel=1;t.treedataindex=0;a.applyTree();a.setTreeEven();if(e.data){t.append(null,e.data)}if(e.url){t.loadData(null,e.url)}if(this.id==undefined||this.id=="")this.id="LigerUI_"+(new Date).getTime();LigerUIManagers[this.id+"_Tree"]=t;this.usedTree=true});if(this.length==0)return null;if(this.length==1)return LigerUIManagers[this[0].id+"_Tree"];var t=[];this.each(function(){t.push(LigerUIManagers[this.id+"_Tree"])});return t}})(jQuery);